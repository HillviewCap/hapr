# HAPR Security Baseline - HAProxy Audit Framework
# Version: 1.0.0
# Last Updated: 2025-05-01
#
# This file defines all security checks performed by the HAPR audit tool.
# Each check maps to industry standards (NIST SP 800-53, OWASP, DISA STIG).

metadata:
  name: HAPR Security Baseline
  version: "1.0.0"
  description: >
    Comprehensive security baseline for HAProxy configurations.
    Covers process hardening, TLS, access control, headers, request handling,
    logging, information disclosure, timeouts, backend/frontend security,
    global settings, live TLS scanning, and known CVE detection.
  author: HAPR Project
  categories:
    - process
    - tls
    - access
    - headers
    - request
    - logging
    - disclosure
    - timeouts
    - backend
    - frontend
    - global_defaults
    - tls_live
    - cve
  severity_weights:
    critical: 10
    high: 7
    medium: 4
    low: 2
    info: 0

checks:

  # ---------------------------------------------------------------------------
  # HAPR-PROC: Process Security
  # ---------------------------------------------------------------------------

  - id: HAPR-PROC-001
    title: Chroot Enabled
    category: process
    severity: high
    weight: 7
    description: >
      Verify that HAProxy is configured to chroot into a restricted directory,
      limiting filesystem access in the event of a compromise.
    rationale: >
      Running HAProxy in a chroot jail confines the process to a dedicated
      directory tree. If an attacker exploits a vulnerability, they cannot
      traverse the full filesystem to access sensitive data or binaries.
    remediation: >
      Add a chroot directive to the global section pointing to an empty,
      dedicated directory. Example: chroot /var/lib/haproxy
    references:
      nist:
        - SC-39
        - CM-7
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000141-WSR-000076
    check_function: process.check_chroot

  - id: HAPR-PROC-002
    title: Runs as Non-Root User
    category: process
    severity: critical
    weight: 10
    description: >
      Verify that HAProxy drops privileges and runs as a non-root user after
      binding to privileged ports.
    rationale: >
      Running network services as root grants the process unrestricted system
      access. If compromised, an attacker inherits full root privileges. HAProxy
      should drop to an unprivileged user immediately after startup.
    remediation: >
      Set the user directive in the global section to a dedicated non-root
      service account. Example: user haproxy
    references:
      nist:
        - AC-6
        - AC-6(2)
        - CM-7
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000141-WSR-000076
        - SRG-APP-000211-WSR-000030
    check_function: process.check_non_root_user

  - id: HAPR-PROC-003
    title: Group Directive Set
    category: process
    severity: medium
    weight: 4
    description: >
      Verify that HAProxy is configured with a dedicated group to further
      restrict process permissions.
    rationale: >
      Setting a dedicated group ensures HAProxy cannot access files owned by
      other groups, reducing the blast radius of a compromise. Combined with
      the user directive, this enforces proper Unix permission boundaries.
    remediation: >
      Add a group directive in the global section. Example: group haproxy
    references:
      nist:
        - AC-6
        - AC-3
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000211-WSR-000030
    check_function: process.check_user_group

  - id: HAPR-PROC-004
    title: Ulimits Configured
    category: process
    severity: low
    weight: 2
    description: >
      Verify that file descriptor ulimits are explicitly configured in the
      global section to prevent resource exhaustion.
    rationale: >
      HAProxy uses file descriptors for every connection. Without explicit
      ulimit settings, the process may hit OS defaults and drop legitimate
      connections during traffic spikes, leading to denial of service.
    remediation: >
      Set ulimit-n in the global section to a value appropriate for your
      expected connection count. Example: ulimit-n 65536
    references:
      nist:
        - SC-5
        - AU-5(1)
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: process.check_ulimits

  # ---------------------------------------------------------------------------
  # HAPR-TLS: TLS/SSL Configuration
  # ---------------------------------------------------------------------------

  - id: HAPR-TLS-001
    title: Minimum TLS Version 1.2
    category: tls
    severity: critical
    weight: 10
    description: >
      Verify that the configuration enforces TLS 1.2 as the minimum accepted
      protocol version, disabling TLS 1.0 and 1.1.
    rationale: >
      TLS 1.0 and 1.1 contain known cryptographic weaknesses including
      susceptibility to BEAST, POODLE, and other downgrade attacks. All major
      browsers and compliance frameworks require TLS 1.2 as the minimum.
    remediation: >
      Set ssl-default-bind-options to include no-sslv3 no-tlsv10 no-tlsv11,
      or use ssl-min-ver TLSv1.2 in HAProxy 2.x and later.
    references:
      nist:
        - SC-8
        - SC-8(1)
        - SC-13
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
        - SRG-APP-000442-WSR-000064
    check_function: tls.check_min_tls_version

  - id: HAPR-TLS-002
    title: No Weak Cipher Strings
    category: tls
    severity: critical
    weight: 10
    description: >
      Verify that the cipher configuration does not include known weak or
      broken cipher suites such as DES, RC4, MD5-based, NULL, or EXPORT
      ciphers.
    rationale: >
      Weak ciphers can be broken with feasible computational effort, allowing
      attackers to decrypt intercepted traffic. RC4 has known biases, DES has
      a 56-bit key, and EXPORT ciphers were intentionally weakened.
    remediation: >
      Configure ssl-default-bind-ciphers with a strong cipher string that
      excludes weak algorithms. Example:
      ssl-default-bind-ciphers ECDHE+AESGCM:DHE+AESGCM:!aNULL:!MD5:!DSS:!RC4:!DES:!3DES:!EXPORT
    references:
      nist:
        - SC-8(1)
        - SC-13
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
        - SRG-APP-000179-WSR-000110
    check_function: tls.check_no_weak_ciphers

  - id: HAPR-TLS-003
    title: SSL Default Bind Options Set
    category: tls
    severity: high
    weight: 7
    description: >
      Verify that ssl-default-bind-options is explicitly configured in the
      global section to enforce secure TLS defaults across all bind lines.
    rationale: >
      Without global ssl-default-bind-options, each bind line must individually
      specify TLS settings, increasing the risk of inconsistent or insecure
      configurations across frontends.
    remediation: >
      Add ssl-default-bind-options in the global section. Example:
      ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11 no-tls-tickets
    references:
      nist:
        - SC-8
        - CM-6
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
    check_function: tls.check_ssl_default_bind_options

  - id: HAPR-TLS-004
    title: SSL Default Bind Ciphers Set
    category: tls
    severity: high
    weight: 7
    description: >
      Verify that ssl-default-bind-ciphers is explicitly configured in the
      global section to enforce a strong cipher suite across all bind lines.
    rationale: >
      A global cipher configuration ensures consistent cryptographic strength
      across all frontends. Without it, HAProxy falls back to OpenSSL defaults
      which may include weak ciphers depending on the library version.
    remediation: >
      Set ssl-default-bind-ciphers in the global section with a curated list
      of strong ciphers. Example:
      ssl-default-bind-ciphers ECDHE+AESGCM:DHE+AESGCM:!aNULL:!MD5:!DSS
    references:
      nist:
        - SC-8(1)
        - SC-13
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000179-WSR-000110
    check_function: tls.check_ssl_default_bind_ciphers

  - id: HAPR-TLS-005
    title: TLS 1.3 Ciphersuites Configured
    category: tls
    severity: medium
    weight: 4
    description: >
      Verify that ssl-default-bind-ciphersuites is configured to specify
      the allowed TLS 1.3 cipher suites explicitly.
    rationale: >
      TLS 1.3 uses a separate ciphersuite directive from TLS 1.2. While all
      TLS 1.3 ciphers are currently considered strong, explicitly setting them
      ensures forward control and auditability as cryptographic standards evolve.
    remediation: >
      Set ssl-default-bind-ciphersuites in the global section. Example:
      ssl-default-bind-ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256
    references:
      nist:
        - SC-13
        - SC-8(1)
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000179-WSR-000110
    check_function: tls.check_ssl_default_bind_ciphersuites

  - id: HAPR-TLS-006
    title: HSTS Header Configured
    category: tls
    severity: high
    weight: 7
    description: >
      Verify that HTTP Strict Transport Security (HSTS) is configured to
      instruct browsers to only connect via HTTPS.
    rationale: >
      Without HSTS, users may initially connect over plain HTTP and be
      vulnerable to man-in-the-middle attacks during the redirect to HTTPS.
      HSTS eliminates this window by instructing browsers to use HTTPS for
      all future requests.
    remediation: >
      Add an HSTS response header with a minimum max-age of 31536000 seconds.
      Example: http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"
    references:
      nist:
        - SC-8
        - SC-8(1)
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
        - SRG-APP-000015-WSR-000014
    check_function: tls.check_hsts_configured

  - id: HAPR-TLS-007
    title: DH Parameter Size at Least 2048 Bits
    category: tls
    severity: medium
    weight: 4
    description: >
      Verify that the Diffie-Hellman parameter size is set to at least 2048
      bits to ensure adequate key exchange strength.
    rationale: >
      DH parameters smaller than 2048 bits are vulnerable to precomputation
      attacks such as Logjam. NIST recommends a minimum of 2048 bits for DH
      key exchange to provide adequate security through 2030.
    remediation: >
      Set tune.ssl.default-dh-param to at least 2048 in the global section.
      Example: tune.ssl.default-dh-param 2048
    references:
      nist:
        - SC-13
        - SC-12
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000179-WSR-000110
    check_function: tls.check_dh_param_size

  # ---------------------------------------------------------------------------
  # HAPR-ACL: Access Control
  # ---------------------------------------------------------------------------

  - id: HAPR-ACL-001
    title: ACLs Defined in Frontends
    category: access
    severity: medium
    weight: 4
    description: >
      Verify that frontend sections define access control lists (ACLs) to
      filter and route traffic based on request attributes.
    rationale: >
      ACLs are the primary mechanism in HAProxy for implementing access
      control policies. Frontends without ACLs pass all traffic to backends
      without any filtering, increasing exposure to malicious requests.
    remediation: >
      Define ACL rules in each frontend to filter traffic by source IP, path,
      headers, or other criteria. Example:
      acl internal_net src 10.0.0.0/8 192.168.0.0/16
    references:
      nist:
        - AC-3
        - AC-4
      owasp:
        - A01:2021 Broken Access Control
      stig:
        - SRG-APP-000315-WSR-000004
    check_function: access.check_acls_defined

  - id: HAPR-ACL-002
    title: Admin Paths Restricted
    category: access
    severity: high
    weight: 7
    requires_mode: http
    description: >
      Verify that administrative paths such as /admin, /manager, and
      /haproxy?stats are restricted by IP address or authentication.
    rationale: >
      Administrative endpoints exposed without access restrictions allow
      attackers to manage or reconfigure the proxy, view sensitive operational
      data, or pivot to backend systems.
    remediation: >
      Use ACLs to restrict admin paths to trusted source IPs or require
      HTTP basic authentication. Example:
      acl admin_path path_beg /admin /manager
      acl trusted_src src 10.0.0.0/8
      http-request deny if admin_path !trusted_src
    references:
      nist:
        - AC-3
        - AC-6
        - AC-6(1)
      owasp:
        - A01:2021 Broken Access Control
      stig:
        - SRG-APP-000315-WSR-000004
        - SRG-APP-000141-WSR-000076
    check_function: access.check_admin_path_restricted

  - id: HAPR-ACL-003
    title: Rate Limiting Configured
    category: access
    severity: high
    weight: 7
    description: >
      Verify that rate limiting is implemented using stick tables, ACLs,
      or external mechanisms to throttle excessive requests.
    rationale: >
      Without rate limiting, HAProxy is vulnerable to brute-force attacks,
      credential stuffing, and application-layer denial of service. Rate
      limiting is essential for protecting backend resources from abuse.
    remediation: >
      Implement rate limiting using stick tables with http_req_rate or
      conn_rate tracking. Example:
      stick-table type ip size 100k expire 30s store http_req_rate(10s)
      http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }
    references:
      nist:
        - SC-5
        - SI-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: access.check_rate_limiting

  - id: HAPR-ACL-004
    title: Stick Tables for Connection Tracking
    category: access
    severity: medium
    weight: 4
    description: >
      Verify that stick tables are configured for connection and request
      tracking to enable abuse detection and rate limiting.
    rationale: >
      Stick tables maintain per-client state that enables HAProxy to detect
      anomalous traffic patterns, enforce rate limits, and support session
      persistence. Without them, abuse detection relies entirely on external
      systems.
    remediation: >
      Configure stick tables in relevant backends or frontends to track
      connection rates, request rates, or byte counters. Example:
      stick-table type ip size 200k expire 5m store conn_cur,conn_rate(3s),http_req_rate(10s)
    references:
      nist:
        - SC-5
        - AU-6
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: access.check_stick_tables

  - id: HAPR-ACL-005
    title: Stats Access Restricted
    category: access
    severity: high
    weight: 7
    description: >
      Verify that the HAProxy stats page, if enabled, is protected with
      authentication and/or IP-based access restrictions.
    rationale: >
      The stats page exposes detailed operational information including server
      health, connection counts, error rates, and backend topology. Unrestricted
      access provides attackers with reconnaissance data for targeting backends.
    remediation: >
      Restrict stats access with authentication and IP filtering. Example:
      stats auth admin:securepassword
      stats admin if LOCALHOST
      acl stats_allowed src 10.0.0.0/8
      http-request deny if !stats_allowed
    references:
      nist:
        - AC-3
        - AC-6
      owasp:
        - A01:2021 Broken Access Control
      stig:
        - SRG-APP-000315-WSR-000004
    check_function: access.check_stats_access_restricted

  # ---------------------------------------------------------------------------
  # HAPR-HDR: HTTP Security Headers
  # ---------------------------------------------------------------------------

  - id: HAPR-HDR-001
    title: X-Frame-Options Header Set
    category: headers
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that the X-Frame-Options header is set to DENY or SAMEORIGIN
      to prevent clickjacking attacks.
    rationale: >
      Without X-Frame-Options, the site can be embedded in iframes on
      malicious pages, enabling clickjacking where users unknowingly interact
      with the proxied application through a disguised interface.
    remediation: >
      Add the X-Frame-Options header in frontend or backend configuration.
      Example: http-response set-header X-Frame-Options DENY
    references:
      nist:
        - SI-10
        - SC-18
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: headers.check_x_frame_options

  - id: HAPR-HDR-002
    title: Content-Security-Policy Header Set
    category: headers
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that a Content-Security-Policy header is configured to restrict
      the sources from which content can be loaded.
    rationale: >
      CSP is the primary defense against cross-site scripting and data
      injection attacks. It restricts which domains can serve scripts, styles,
      images, and other resources, significantly reducing the attack surface
      for XSS.
    remediation: >
      Add a Content-Security-Policy header. Start with a restrictive policy
      and relax as needed. Example:
      http-response set-header Content-Security-Policy "default-src 'self'; script-src 'self'"
    references:
      nist:
        - SI-10
        - SC-18
      owasp:
        - A03:2021 Injection
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: headers.check_csp_header

  - id: HAPR-HDR-003
    title: X-Content-Type-Options Header Set
    category: headers
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that the X-Content-Type-Options header is set to nosniff to
      prevent MIME type confusion attacks.
    rationale: >
      Without nosniff, browsers may attempt to guess the MIME type of a
      response, potentially interpreting data files as executable content.
      This enables attacks where malicious content is served with an
      innocuous Content-Type.
    remediation: >
      Add the X-Content-Type-Options header. Example:
      http-response set-header X-Content-Type-Options nosniff
    references:
      nist:
        - SI-10
        - SC-18
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: headers.check_x_content_type_options

  - id: HAPR-HDR-004
    title: Referrer-Policy Header Set
    category: headers
    severity: low
    weight: 2
    requires_mode: http
    description: >
      Verify that a Referrer-Policy header is configured to control how
      much referrer information is sent with requests.
    rationale: >
      By default, browsers send the full URL as a referrer to third-party
      sites, potentially leaking sensitive path components, query parameters,
      or session tokens contained in URLs.
    remediation: >
      Set a restrictive Referrer-Policy header. Example:
      http-response set-header Referrer-Policy strict-origin-when-cross-origin
    references:
      nist:
        - SC-8
        - SI-11
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: headers.check_referrer_policy

  - id: HAPR-HDR-005
    title: Permissions-Policy Header Set
    category: headers
    severity: low
    weight: 2
    requires_mode: http
    description: >
      Verify that a Permissions-Policy header is configured to restrict
      access to browser features and APIs.
    rationale: >
      Permissions-Policy allows control over which browser features (camera,
      microphone, geolocation, etc.) can be used by the page and its embedded
      content. Without it, embedded iframes may access sensitive device
      capabilities.
    remediation: >
      Add a Permissions-Policy header restricting unnecessary features.
      Example:
      http-response set-header Permissions-Policy "camera=(), microphone=(), geolocation=()"
    references:
      nist:
        - SC-18
        - AC-4
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: headers.check_permissions_policy

  - id: HAPR-HDR-006
    title: X-XSS-Protection Not Misconfigured
    category: headers
    severity: low
    weight: 2
    requires_mode: http
    description: >
      Verify that the X-XSS-Protection header is either absent, set to 0,
      or not set to 1; mode=block. This header is deprecated and enabling
      it can introduce vulnerabilities in older browsers.
    rationale: >
      The X-XSS-Protection header is deprecated and its filter has been
      removed from modern browsers. Setting it to 1 or 1; mode=block can
      actually introduce cross-site leak vulnerabilities in older browsers
      that still implement the XSS Auditor. CSP should be used instead.
    remediation: >
      Either remove the X-XSS-Protection header entirely or set it to 0.
      Example: http-response set-header X-XSS-Protection "0"
      Rely on Content-Security-Policy for XSS mitigation instead.
    references:
      nist:
        - SI-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: headers.check_x_xss_protection

  # ---------------------------------------------------------------------------
  # HAPR-REQ: Request Handling
  # ---------------------------------------------------------------------------

  - id: HAPR-REQ-001
    title: Maximum Request Body Size Limited
    category: request
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that the maximum allowed request body size is explicitly limited
      to prevent resource exhaustion from oversized payloads.
    rationale: >
      Without body size limits, an attacker can send extremely large request
      bodies to exhaust memory and disk resources on HAProxy or backend
      servers, causing denial of service. This also mitigates some buffer
      overflow attempts.
    remediation: >
      Set a maximum body size appropriate for your application. Example:
      http-request deny deny_status 413 if { req.body_size gt 10485760 }
    references:
      nist:
        - SC-5
        - SI-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: request.check_max_body_size

  - id: HAPR-REQ-002
    title: URL Length Limits Configured
    category: request
    severity: low
    weight: 2
    requires_mode: http
    description: >
      Verify that URL length limits are configured to reject abnormally
      long request URIs that may indicate attacks.
    rationale: >
      Extremely long URLs can be used for buffer overflow attempts, denial
      of service, or to bypass security filters. Limiting URL length to a
      reasonable value reduces the attack surface.
    remediation: >
      Configure tune.http.maxuri in the global section or use an ACL to
      reject long URLs. Example:
      http-request deny deny_status 414 if { url_len gt 8192 }
    references:
      nist:
        - SI-10
        - SC-5
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: request.check_url_length_limits

  - id: HAPR-REQ-003
    title: HTTP Method Filtering
    category: request
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that only required HTTP methods are allowed and dangerous or
      unnecessary methods such as TRACE, DELETE, and OPTIONS are restricted.
    rationale: >
      The TRACE method can be exploited for cross-site tracing attacks to
      steal credentials. Unrestricted methods like PUT and DELETE may allow
      unauthorized data modification on misconfigured backends. Only methods
      required by the application should be permitted.
    remediation: >
      Create an ACL to whitelist allowed methods and deny all others.
      Example:
      acl valid_method method GET HEAD POST
      http-request deny if !valid_method
    references:
      nist:
        - CM-7
        - AC-3
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000141-WSR-000076
        - SRG-APP-000315-WSR-000004
    check_function: request.check_method_filtering

  - id: HAPR-REQ-004
    title: Request Header Size Limits
    category: request
    severity: low
    weight: 2
    requires_mode: http
    description: >
      Verify that request header size limits are configured to prevent
      abuse through oversized headers.
    rationale: >
      Large headers can be used for denial of service, smuggling attacks,
      or to exploit parsing vulnerabilities in HAProxy or backend servers.
      Reasonable limits protect against these attack vectors.
    remediation: >
      Set tune.http.maxhdr and tune.bufsize in the global section. Example:
      tune.http.maxhdr 101
      tune.bufsize 16384
    references:
      nist:
        - SC-5
        - SI-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: request.check_request_header_limits

  # ---------------------------------------------------------------------------
  # HAPR-LOG: Logging & Monitoring
  # ---------------------------------------------------------------------------

  - id: HAPR-LOG-001
    title: Log Directive Present
    category: logging
    severity: high
    weight: 7
    description: >
      Verify that at least one log directive is configured in the global
      section to enable event logging.
    rationale: >
      Without logging, security incidents, errors, and performance issues
      cannot be detected, investigated, or correlated. Logging is a
      foundational requirement for security monitoring, incident response,
      and compliance.
    remediation: >
      Add a log directive pointing to a syslog server or local socket.
      Example: log 127.0.0.1:514 local0
    references:
      nist:
        - AU-2
        - AU-3
        - AU-12
      owasp:
        - A09:2021 Security Logging and Monitoring Failures
      stig:
        - SRG-APP-000092-WSR-000055
        - SRG-APP-000095-WSR-000056
    check_function: logging_checks.check_logging_configured

  - id: HAPR-LOG-002
    title: Detailed Log Format Configured
    category: logging
    severity: medium
    weight: 4
    description: >
      Verify that the log format includes sufficient detail for security
      analysis, such as client IP, request method, URL, status code, and
      timing information.
    rationale: >
      Default log formats may omit critical fields needed for security
      investigation. Detailed logging enables correlation of events, detection
      of attack patterns, and forensic analysis after incidents.
    remediation: >
      Configure a custom log-format that includes security-relevant fields.
      Example:
      log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
    references:
      nist:
        - AU-3
        - AU-3(1)
        - AU-8
      owasp:
        - A09:2021 Security Logging and Monitoring Failures
      stig:
        - SRG-APP-000095-WSR-000056
        - SRG-APP-000096-WSR-000057
    check_function: logging_checks.check_log_format

  - id: HAPR-LOG-003
    title: Stats Page Secured with Authentication
    category: logging
    severity: high
    weight: 7
    description: >
      Verify that the HAProxy statistics page requires authentication and
      is not exposed without credentials.
    rationale: >
      The stats page reveals detailed information about HAProxy internals
      including server names, health status, connection metrics, and error
      rates. Without authentication, this information aids attackers in
      planning targeted attacks against backend infrastructure.
    remediation: >
      Enable authentication on the stats page and bind it to a restricted
      address. Example:
      stats enable
      stats uri /haproxy-stats
      stats auth admin:strong-password-here
      stats hide-version
    references:
      nist:
        - AC-3
        - AU-9
      owasp:
        - A01:2021 Broken Access Control
        - A09:2021 Security Logging and Monitoring Failures
      stig:
        - SRG-APP-000315-WSR-000004
    check_function: logging_checks.check_stats_secured

  - id: HAPR-LOG-004
    title: Appropriate Log Level
    category: logging
    severity: low
    weight: 2
    description: >
      Verify that the log level is set appropriately, capturing sufficient
      detail without excessive noise that could obscure security events.
    rationale: >
      A log level that is too low (e.g., emerg) will miss important security
      events. A level that is too high (e.g., debug) in production generates
      excessive volume that can fill disks, degrade performance, and make
      analysis difficult.
    remediation: >
      Set the log level to info or notice for production environments.
      Use warning or higher only if log volume is carefully managed.
      Example: log 127.0.0.1:514 local0 info
    references:
      nist:
        - AU-2
        - AU-5
      owasp:
        - A09:2021 Security Logging and Monitoring Failures
      stig:
        - SRG-APP-000092-WSR-000055
    check_function: logging_checks.check_log_level

  - id: HAPR-LOG-005
    title: HTTP or TCP Log Option Enabled
    category: logging
    severity: medium
    weight: 4
    description: >
      Verify that option httplog or option tcplog is enabled to capture
      protocol-level details in log entries.
    rationale: >
      Without httplog or tcplog, HAProxy uses a minimal log format that
      omits request details, status codes, and timing metrics. These details
      are essential for detecting web attacks, troubleshooting issues, and
      meeting audit requirements.
    remediation: >
      Enable the appropriate log option in defaults or each frontend/backend.
      Example: option httplog
    references:
      nist:
        - AU-3
        - AU-12
      owasp:
        - A09:2021 Security Logging and Monitoring Failures
      stig:
        - SRG-APP-000095-WSR-000056
    check_function: logging_checks.check_httplog_or_tcplog

  # ---------------------------------------------------------------------------
  # HAPR-INF: Information Disclosure
  # ---------------------------------------------------------------------------

  - id: HAPR-INF-001
    title: Server Header Removed
    category: disclosure
    severity: high
    weight: 7
    requires_mode: http
    description: >
      Verify that the Server response header is removed or replaced to
      prevent disclosure of backend server software and versions.
    rationale: >
      The Server header typically reveals the backend web server software
      and version, giving attackers specific version information to search
      for known vulnerabilities. Removing it forces attackers to use more
      detectable fingerprinting techniques.
    remediation: >
      Remove or overwrite the Server header using a response rule.
      Example: http-response del-header Server
    references:
      nist:
        - SC-8
        - SI-11
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000266-WSR-000160
    check_function: disclosure.check_server_header_removed

  - id: HAPR-INF-002
    title: Custom Error Pages Configured
    category: disclosure
    severity: medium
    weight: 4
    description: >
      Verify that custom error pages are configured to replace default
      HAProxy error responses that may reveal software details.
    rationale: >
      Default error pages often include the software name and version,
      internal server details, or stack traces. Custom error pages present
      a consistent user experience while preventing information leakage.
    remediation: >
      Configure custom error files for common HTTP error codes. Example:
      errorfile 400 /etc/haproxy/errors/400.http
      errorfile 403 /etc/haproxy/errors/403.http
      errorfile 500 /etc/haproxy/errors/500.http
      errorfile 502 /etc/haproxy/errors/502.http
      errorfile 503 /etc/haproxy/errors/503.http
    references:
      nist:
        - SI-11
        - SC-8
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000266-WSR-000160
    check_function: disclosure.check_custom_error_pages

  - id: HAPR-INF-003
    title: Version Information Hidden
    category: disclosure
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that HAProxy version information is not disclosed in HTTP
      headers, error pages, or other responses.
    rationale: >
      Disclosing the exact HAProxy version enables attackers to identify
      specific vulnerabilities that affect that version. Hiding version
      information is a simple defense-in-depth measure that increases the
      cost of reconnaissance.
    remediation: >
      Ensure no version strings are exposed in headers or error pages.
      Remove or replace any headers that include HAProxy version details.
      Example: http-response del-header X-Powered-By
    references:
      nist:
        - SI-11
        - CM-7
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000266-WSR-000160
    check_function: disclosure.check_version_hidden

  - id: HAPR-INF-004
    title: Stats Page Version Hidden
    category: disclosure
    severity: low
    weight: 2
    description: >
      Verify that the stats page is configured with stats hide-version to
      prevent HAProxy version disclosure on the statistics page.
    rationale: >
      The HAProxy stats page displays the version number by default. Even
      with authentication, the version disclosure provides useful
      reconnaissance data if credentials are compromised or the page is
      accidentally exposed.
    remediation: >
      Add stats hide-version in the stats configuration. Example:
      stats hide-version
    references:
      nist:
        - SI-11
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000266-WSR-000160
    check_function: disclosure.check_stats_version_hidden

  # ---------------------------------------------------------------------------
  # HAPR-TMO: Timeout Configuration
  # ---------------------------------------------------------------------------

  - id: HAPR-TMO-001
    title: Client Timeout Set
    category: timeouts
    severity: high
    weight: 7
    description: >
      Verify that the client timeout (timeout client) is explicitly set
      to limit how long HAProxy waits for data from the client.
    rationale: >
      Without a client timeout, slow or abandoned connections remain open
      indefinitely, consuming file descriptors and memory. Attackers can
      exploit this with slowloris-style attacks to exhaust connection
      capacity and cause denial of service.
    remediation: >
      Set a client timeout appropriate for your application. Example:
      timeout client 30s
    references:
      nist:
        - SC-5
        - SC-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
        - SRG-APP-000295-WSR-000134
    check_function: timeouts.check_client_timeout

  - id: HAPR-TMO-002
    title: Server Timeout Set
    category: timeouts
    severity: high
    weight: 7
    description: >
      Verify that the server timeout (timeout server) is explicitly set
      to limit how long HAProxy waits for a response from backends.
    rationale: >
      Without a server timeout, requests to unresponsive backends hold
      connections open indefinitely. This wastes proxy resources, prevents
      failover to healthy backends, and can cascade into broader service
      degradation.
    remediation: >
      Set a server timeout appropriate for your backend response times.
      Example: timeout server 30s
    references:
      nist:
        - SC-5
        - SC-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000295-WSR-000134
    check_function: timeouts.check_server_timeout

  - id: HAPR-TMO-003
    title: Connect Timeout Set
    category: timeouts
    severity: high
    weight: 7
    description: >
      Verify that the connection timeout (timeout connect) is explicitly
      set to limit how long HAProxy waits to establish a backend connection.
    rationale: >
      Without a connect timeout, HAProxy waits indefinitely for backend
      connections that may never complete due to network issues or overloaded
      servers. This ties up proxy resources and delays failover to other
      backends.
    remediation: >
      Set a connect timeout appropriate for your network topology. Example:
      timeout connect 5s
    references:
      nist:
        - SC-5
        - SC-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000295-WSR-000134
    check_function: timeouts.check_connect_timeout

  - id: HAPR-TMO-004
    title: HTTP Request Timeout Set
    category: timeouts
    severity: medium
    weight: 4
    description: >
      Verify that the HTTP request timeout (timeout http-request) is set
      to limit how long HAProxy waits for a complete HTTP request.
    rationale: >
      The http-request timeout is critical for defending against slowloris
      attacks, where clients send headers very slowly to hold connections
      open. Without this timeout, a small number of attackers can exhaust
      all available connections.
    remediation: >
      Set a http-request timeout to limit initial request time. Example:
      timeout http-request 10s
    references:
      nist:
        - SC-5
        - SI-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: timeouts.check_http_request_timeout

  - id: HAPR-TMO-005
    title: Timeout Values Are Reasonable
    category: timeouts
    severity: medium
    weight: 4
    description: >
      Verify that timeout values are set to reasonable durations and are
      not excessively long, which would negate their protective purpose.
    rationale: >
      Timeouts that are set to extremely long durations (e.g., hours or
      days) provide little protection against resource exhaustion or
      slowloris attacks. Timeouts should balance application requirements
      with security, typically not exceeding a few minutes for most values.
    remediation: >
      Review all timeout values and ensure they are appropriate. General
      guidelines: connect 5-10s, client 30-60s, server 30-60s,
      http-request 5-15s. Adjust based on application needs but avoid
      values exceeding 300s without specific justification.
    references:
      nist:
        - SC-5
        - SC-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000295-WSR-000134
    check_function: timeouts.check_timeout_values_reasonable

  # ---------------------------------------------------------------------------
  # HAPR-BKD: Backend Security
  # ---------------------------------------------------------------------------

  - id: HAPR-BKD-001
    title: Health Checks Configured
    category: backend
    severity: high
    weight: 7
    description: >
      Verify that backend server health checks are configured to detect
      and remove unhealthy servers from the load balancing rotation.
    rationale: >
      Without health checks, HAProxy continues sending traffic to failed
      or compromised backends, resulting in errors for users and potential
      security issues if a compromised server serves malicious content.
    remediation: >
      Enable health checks on backend servers using the check keyword and
      configure appropriate intervals. Example:
      server web1 10.0.0.1:80 check inter 5s fall 3 rise 2
    references:
      nist:
        - SC-5
        - SI-6
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: backend.check_health_checks

  - id: HAPR-BKD-002
    title: Connection Limits on Backend Servers
    category: backend
    severity: medium
    weight: 4
    description: >
      Verify that per-server connection limits (maxconn) are configured on
      backend servers to prevent overloading individual hosts.
    rationale: >
      Without connection limits, a single backend server may receive more
      connections than it can handle, leading to degraded performance or
      crashes. Connection limits also help contain the impact if one server
      is slower due to compromise or resource issues.
    remediation: >
      Set maxconn on individual backend servers. Example:
      server web1 10.0.0.1:80 check maxconn 500
    references:
      nist:
        - SC-5
        - SC-6
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: backend.check_connection_limits

  - id: HAPR-BKD-003
    title: Backend SSL/TLS to Servers
    category: backend
    severity: medium
    weight: 4
    description: >
      Verify that backend connections to servers use SSL/TLS to encrypt
      traffic between HAProxy and backend hosts.
    rationale: >
      Unencrypted backend connections expose request and response data to
      network sniffing on the backend network. If the backend network is
      compromised, an attacker can intercept sensitive data including
      authentication tokens and personal information.
    remediation: >
      Enable SSL on backend server lines. Example:
      server web1 10.0.0.1:443 ssl verify required ca-file /etc/ssl/certs/ca-bundle.crt check
    references:
      nist:
        - SC-8
        - SC-8(1)
        - SC-23
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
    check_function: backend.check_backend_ssl

  - id: HAPR-BKD-004
    title: Cookie Attributes Set Securely
    category: backend
    severity: medium
    weight: 4
    description: >
      Verify that session persistence cookies set by HAProxy include the
      Secure, HttpOnly, and SameSite attributes.
    rationale: >
      HAProxy persistence cookies without Secure can be sent over plain
      HTTP, leaking session information. Without HttpOnly, cookies are
      accessible to JavaScript, enabling theft via XSS. Without SameSite,
      cookies may be sent in cross-site requests, enabling CSRF attacks.
    remediation: >
      Configure cookie attributes in backend sections. Example:
      cookie SERVERID insert indirect nocache httponly secure attr SameSite=Strict
    references:
      nist:
        - SC-8
        - SC-23
      owasp:
        - A01:2021 Broken Access Control
      stig:
        - SRG-APP-000439-WSR-000156
        - SRG-APP-000023-WSR-000012
    check_function: backend.check_cookie_security

  - id: HAPR-BKD-005
    title: Retry and Redispatch Configured
    category: backend
    severity: low
    weight: 2
    description: >
      Verify that retry and redispatch options are configured to handle
      backend failures gracefully.
    rationale: >
      Without retries and redispatch, a single backend failure results in
      an immediate error to the user. Proper retry logic with redispatch
      allows HAProxy to transparently failover to a healthy server, improving
      availability and resilience against targeted backend attacks.
    remediation: >
      Configure retries and enable redispatch in the defaults or backend
      section. Example:
      retries 3
      option redispatch
    references:
      nist:
        - SC-5
        - CP-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: backend.check_retry_redispatch

  # ---------------------------------------------------------------------------
  # HAPR-FRT: Frontend Security
  # ---------------------------------------------------------------------------

  - id: HAPR-FRT-001
    title: Connection Limits on Frontends
    category: frontend
    severity: medium
    weight: 4
    description: >
      Verify that frontend sections have connection limits configured to
      prevent resource exhaustion from excessive concurrent connections.
    rationale: >
      Without frontend connection limits, an attacker can open thousands of
      connections to exhaust HAProxy resources and prevent legitimate users
      from connecting. Limits bound the maximum resource consumption per
      frontend.
    remediation: >
      Set maxconn in each frontend section. Example:
      frontend web
        bind *:443 ssl crt /etc/ssl/cert.pem
        maxconn 10000
    references:
      nist:
        - SC-5
        - SC-6
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: frontend.check_frontend_connection_limits

  - id: HAPR-FRT-002
    title: Global Maxconn Reflected in Frontends
    category: frontend
    severity: medium
    weight: 4
    description: >
      Verify that maxconn is explicitly set in frontend sections rather than
      relying solely on the global default.
    rationale: >
      Frontends without explicit maxconn inherit the global value, which
      may be too high for a specific frontend. Explicit per-frontend limits
      allow fine-grained control over resource allocation and ensure no
      single frontend can consume all available connections.
    remediation: >
      Set maxconn in each frontend based on expected traffic. Example:
      frontend api
        maxconn 5000
      frontend web
        maxconn 10000
    references:
      nist:
        - SC-5
        - CM-6
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: frontend.check_maxconn_set

  - id: HAPR-FRT-003
    title: HTTP to HTTPS Redirect
    category: frontend
    severity: high
    weight: 7
    requires_mode: http
    description: >
      Verify that HTTP frontends redirect to HTTPS to ensure all traffic
      is encrypted in transit.
    rationale: >
      Serving content over plain HTTP exposes all data to network
      interception. Redirecting HTTP to HTTPS ensures encryption is applied
      to every connection, protecting credentials, session tokens, and
      sensitive data from eavesdropping.
    remediation: >
      Configure an HTTP frontend that redirects to HTTPS. Example:
      frontend http-redirect
        bind *:80
        http-request redirect scheme https unless { ssl_fc }
    references:
      nist:
        - SC-8
        - SC-8(1)
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
        - SRG-APP-000015-WSR-000014
    check_function: frontend.check_http_to_https_redirect

  - id: HAPR-FRT-004
    title: WAF Integration Detected
    category: frontend
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that web application firewall integration is present, such as
      SPOE-based ModSecurity or similar WAF engine integration.
    rationale: >
      HAProxy alone provides basic traffic filtering but lacks deep packet
      inspection capabilities. WAF integration enables detection and blocking
      of complex attack payloads including SQL injection, cross-site
      scripting, and other OWASP Top 10 attacks.
    remediation: >
      Integrate a WAF engine using HAProxy SPOE (Stream Processing Offload
      Engine). Example:
      filter spoe engine modsecurity config /etc/haproxy/spoe-modsecurity.conf
    references:
      nist:
        - SI-3
        - SI-4
      owasp:
        - A03:2021 Injection
      stig:
        - SRG-APP-000141-WSR-000076
    check_function: frontend.check_waf_integration

  - id: HAPR-FRT-005
    title: SQL Injection Protection Rules
    category: frontend
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that ACL rules or WAF integration provides protection against
      SQL injection patterns in request parameters and URLs.
    rationale: >
      SQL injection remains one of the most common and dangerous web
      application attacks. While backend applications should use parameterized
      queries, proxy-level filtering provides defense in depth by blocking
      common injection patterns before they reach the application.
    remediation: >
      Add ACL rules to detect and block common SQL injection patterns.
      Example:
      acl sqli_detect url_sub -i select union insert drop update delete
      acl sqli_param url_sub -i ' OR 1=1 ' -- ;--
      http-request deny if sqli_detect OR sqli_param
    references:
      nist:
        - SI-10
        - SI-3
      owasp:
        - A03:2021 Injection
      stig:
        - SRG-APP-000251-WSR-000157
    check_function: frontend.check_sql_injection_protection

  - id: HAPR-FRT-006
    title: XSS Protection Rules
    category: frontend
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that ACL rules or WAF integration provides protection against
      cross-site scripting patterns in request data.
    rationale: >
      Cross-site scripting allows attackers to inject malicious scripts into
      web pages viewed by other users. Proxy-level filtering provides an
      additional layer of defense by blocking common XSS patterns such as
      script tags and event handlers before they reach the application.
    remediation: >
      Add ACL rules to detect and block common XSS patterns. Example:
      acl xss_detect url_sub -i <script javascript: onerror onload
      http-request deny if xss_detect
    references:
      nist:
        - SI-10
        - SI-3
      owasp:
        - A03:2021 Injection
        - A07:2021 Cross-Site Scripting
      stig:
        - SRG-APP-000251-WSR-000157
    check_function: frontend.check_xss_protection

  # ---------------------------------------------------------------------------
  # HAPR-GBL: Global & Defaults
  # ---------------------------------------------------------------------------

  - id: HAPR-GBL-001
    title: Secure Defaults Section Exists
    category: global_defaults
    severity: high
    weight: 7
    description: >
      Verify that a defaults section exists and contains baseline security
      settings including timeouts, logging, and connection options.
    rationale: >
      The defaults section provides a security baseline that all frontends
      and backends inherit. Without a properly configured defaults section,
      each section must independently specify every setting, increasing the
      risk of accidental omissions.
    remediation: >
      Create a defaults section with essential security settings. Example:
      defaults
        mode http
        log global
        option httplog
        option dontlognull
        timeout connect 5s
        timeout client 30s
        timeout server 30s
    references:
      nist:
        - CM-6
        - CM-2
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: global_defaults.check_secure_defaults

  - id: HAPR-GBL-002
    title: Stats Socket Permissions Restricted
    category: global_defaults
    severity: high
    weight: 7
    description: >
      Verify that the HAProxy stats socket has restrictive file permissions
      and is not world-accessible.
    rationale: >
      The stats socket provides full administrative control over HAProxy,
      including the ability to disable servers, change weights, and view
      sensitive metrics. World-readable or world-writable permissions allow
      any local user to manipulate the proxy configuration.
    remediation: >
      Set restrictive permissions on the stats socket. Example:
      stats socket /var/run/haproxy/admin.sock mode 660 level admin user haproxy group haproxy
    references:
      nist:
        - AC-3
        - AC-6
        - CM-6
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000141-WSR-000076
        - SRG-APP-000315-WSR-000004
    check_function: global_defaults.check_stats_socket_permissions

  - id: HAPR-GBL-003
    title: DNS Resolver Configured
    category: global_defaults
    severity: low
    weight: 2
    description: >
      Verify that a DNS resolver section is configured for backends using
      DNS-based server discovery, ensuring DNS resolution is controlled.
    rationale: >
      Using system DNS resolution without explicit configuration may rely on
      insecure or unreliable resolvers. A dedicated resolver section allows
      specifying trusted DNS servers, controlling TTL behavior, and ensuring
      HAProxy can resolve backend addresses even during DNS disruptions.
    remediation: >
      Configure a resolvers section with trusted DNS servers. Example:
      resolvers mydns
        nameserver dns1 10.0.0.2:53
        nameserver dns2 10.0.0.3:53
        resolve_retries 3
        timeout resolve 1s
        timeout retry 1s
        hold valid 10s
    references:
      nist:
        - SC-20
        - SC-22
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: global_defaults.check_dns_resolver

  - id: HAPR-GBL-004
    title: Global Maxconn Set
    category: global_defaults
    severity: medium
    weight: 4
    description: >
      Verify that the global maxconn value is explicitly set to limit the
      total number of concurrent connections HAProxy will accept.
    rationale: >
      Without a global maxconn, HAProxy may accept more connections than
      system resources can support, leading to memory exhaustion and process
      instability. An explicit limit ensures predictable resource consumption
      and prevents system-wide impact from traffic surges.
    remediation: >
      Set maxconn in the global section based on available system resources.
      Example:
      global
        maxconn 50000
    references:
      nist:
        - SC-5
        - SC-6
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: global_defaults.check_global_maxconn

  - id: HAPR-GBL-005
    title: Default DH Parameter Size Set
    category: global_defaults
    severity: medium
    weight: 4
    description: >
      Verify that tune.ssl.default-dh-param is explicitly configured in the
      global section to ensure adequate Diffie-Hellman key exchange strength.
    rationale: >
      HAProxy defaults to a 1024-bit DH parameter if not explicitly set,
      which is considered weak and vulnerable to precomputation attacks
      (Logjam). Explicit configuration to 2048 bits or higher is required
      for compliance with current cryptographic standards.
    remediation: >
      Set the DH parameter size in the global section. Example:
      tune.ssl.default-dh-param 2048
    references:
      nist:
        - SC-12
        - SC-13
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000179-WSR-000110
    check_function: global_defaults.check_ssl_dh_param

  # ---------------------------------------------------------------------------
  # HAPR-SCAN: Live TLS Scan
  # ---------------------------------------------------------------------------

  - id: HAPR-SCAN-001
    title: No Deprecated TLS Versions Accepted
    category: tls_live
    severity: critical
    weight: 10
    description: >
      Perform a live scan to verify that the HAProxy endpoint does not
      accept connections using deprecated TLS versions (SSLv2, SSLv3,
      TLS 1.0, TLS 1.1).
    rationale: >
      Configuration analysis alone cannot guarantee runtime behavior, as
      OpenSSL compilation flags or library versions may override config
      settings. A live scan confirms that deprecated protocol versions are
      actually rejected by the running service.
    remediation: >
      If deprecated versions are accepted despite configuration, verify the
      OpenSSL version supports the configured restrictions and rebuild if
      necessary. Check for bind-line overrides that may re-enable old
      protocols.
    references:
      nist:
        - SC-8
        - SC-8(1)
        - SC-13
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
        - SRG-APP-000442-WSR-000064
    check_function: tls_live.check_deprecated_protocols_live
    requires: scanner

  - id: HAPR-SCAN-002
    title: No Weak Ciphers Negotiated
    category: tls_live
    severity: critical
    weight: 10
    description: >
      Perform a live scan to verify that the HAProxy endpoint does not
      negotiate weak cipher suites including NULL, EXPORT, DES, RC4,
      and anonymous ciphers.
    rationale: >
      Live cipher scanning validates that the running configuration actually
      rejects weak ciphers. Misconfigured cipher strings, OpenSSL defaults,
      or compilation options may allow weak ciphers even when the
      configuration appears correct.
    remediation: >
      If weak ciphers are negotiated, review the effective cipher list using
      openssl ciphers and adjust ssl-default-bind-ciphers. Ensure no
      individual bind lines override the global cipher settings.
    references:
      nist:
        - SC-8(1)
        - SC-13
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
        - SRG-APP-000179-WSR-000110
    check_function: tls_live.check_weak_ciphers_live
    requires: scanner

  - id: HAPR-SCAN-003
    title: Valid Certificate Chain
    category: tls_live
    severity: high
    weight: 7
    description: >
      Perform a live scan to verify that the server presents a valid
      certificate chain from a trusted certificate authority, with no
      missing intermediate certificates.
    rationale: >
      An incomplete or invalid certificate chain causes TLS warnings or
      failures in clients, pushing users to bypass security warnings. Missing
      intermediate certificates are a common misconfiguration that breaks
      chain validation for strict clients.
    remediation: >
      Ensure the certificate file includes the full chain in order: server
      certificate, intermediate certificates, and optionally the root CA.
      Use openssl s_client -connect host:port to verify the chain.
    references:
      nist:
        - SC-8
        - IA-5(2)
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000427-WSR-000186
    check_function: tls_live.check_certificate_chain
    requires: scanner

  - id: HAPR-SCAN-004
    title: Certificate Not Expired
    category: tls_live
    severity: critical
    weight: 10
    description: >
      Perform a live scan to verify that the server certificate is currently
      valid and has not expired or is not yet valid.
    rationale: >
      An expired certificate causes immediate TLS failures or browser
      warnings, degrading security posture and user trust. Certificate
      expiration is a top cause of service disruptions and may indicate
      neglected security maintenance processes.
    remediation: >
      Renew the certificate before expiration. Implement automated
      certificate renewal using ACME/Let's Encrypt or your CA's renewal
      process. Set up monitoring alerts for certificates expiring within 30
      days.
    references:
      nist:
        - SC-8
        - SC-17
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000427-WSR-000186
    check_function: tls_live.check_certificate_expiry
    requires: scanner

  - id: HAPR-SCAN-005
    title: No Known TLS Vulnerabilities
    category: tls_live
    severity: critical
    weight: 10
    description: >
      Perform a live scan to check for known TLS implementation
      vulnerabilities including Heartbleed (CVE-2014-0160), ROBOT attack,
      and CCS Injection (CVE-2014-0224).
    rationale: >
      These vulnerabilities allow attackers to extract private keys
      (Heartbleed), decrypt TLS traffic (ROBOT), or perform man-in-the-middle
      attacks (CCS Injection). They exist at the implementation level and
      cannot be detected through configuration analysis alone.
    remediation: >
      Update OpenSSL to the latest patched version. Heartbleed requires
      OpenSSL 1.0.1g or later. CCS Injection requires OpenSSL 0.9.8za,
      1.0.0m, or 1.0.1h or later. After patching, regenerate all private
      keys and certificates.
    references:
      nist:
        - SC-8
        - SI-2
        - RA-5
      owasp:
        - A06:2021 Vulnerable and Outdated Components
      stig:
        - SRG-APP-000439-WSR-000156
        - SRG-APP-000454-WSR-000170
    check_function: tls_live.check_tls_vulnerabilities
    requires: scanner

  - id: HAPR-SCAN-006
    title: Secure Renegotiation Supported
    category: tls_live
    severity: medium
    weight: 4
    description: >
      Perform a live scan to verify that the server supports secure TLS
      renegotiation (RFC 5746) and does not allow insecure client-initiated
      renegotiation.
    rationale: >
      Insecure renegotiation allows attackers to inject plaintext into a TLS
      connection, leading to request smuggling or data injection. Client-
      initiated renegotiation can also be used for denial-of-service attacks
      by forcing expensive cryptographic operations.
    remediation: >
      Ensure OpenSSL is compiled with secure renegotiation support (standard
      in modern versions). Disable client-initiated renegotiation by updating
      to HAProxy 1.8+ which disables it by default, or use
      ssl-default-bind-options no-tls-tickets.
    references:
      nist:
        - SC-8
        - SC-13
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
    check_function: tls_live.check_secure_renegotiation_live
    requires: scanner

  # ---------------------------------------------------------------------------
  # HAPR-CVE: Known Vulnerabilities
  # ---------------------------------------------------------------------------

  - id: HAPR-CVE-001
    title: No Critical CVEs for Detected Version
    category: cve
    severity: critical
    weight: 10
    description: >
      Check the detected HAProxy version against a database of known
      critical CVEs to identify unpatched vulnerabilities with CVSS scores
      of 9.0 or higher.
    rationale: >
      Critical CVEs represent vulnerabilities that can be exploited remotely
      with minimal complexity, often leading to complete system compromise.
      Running a version with known critical vulnerabilities puts the entire
      infrastructure at immediate risk.
    remediation: >
      Upgrade HAProxy to the latest stable release that patches all known
      critical CVEs. Review the HAProxy security advisories at
      https://www.haproxy.org/bugs.html and plan immediate remediation.
    references:
      nist:
        - SI-2
        - SI-2(2)
        - RA-5
      owasp:
        - A06:2021 Vulnerable and Outdated Components
      stig:
        - SRG-APP-000456-WSR-000187
        - SRG-APP-000454-WSR-000170
    check_function: cve.check_critical_cves
    requires: version

  - id: HAPR-CVE-002
    title: No High Severity CVEs for Detected Version
    category: cve
    severity: high
    weight: 7
    description: >
      Check the detected HAProxy version against a database of known high
      severity CVEs to identify unpatched vulnerabilities with CVSS scores
      between 7.0 and 8.9.
    rationale: >
      High severity CVEs can lead to significant security impact including
      remote code execution, privilege escalation, or data exposure. While
      they may require more specific conditions than critical CVEs, they
      still represent serious risk to the deployment.
    remediation: >
      Plan an upgrade to the latest stable HAProxy release within your
      maintenance window. Review each CVE to determine if temporary
      mitigations (such as configuration changes) can reduce risk until the
      upgrade is completed.
    references:
      nist:
        - SI-2
        - RA-5
      owasp:
        - A06:2021 Vulnerable and Outdated Components
      stig:
        - SRG-APP-000456-WSR-000187
    check_function: cve.check_high_cves
    requires: version

  - id: HAPR-CVE-003
    title: HTTP Request Smuggling CVE-2021-40346
    category: cve
    severity: critical
    weight: 10
    description: >
      Check specifically for CVE-2021-40346, an integer overflow
      vulnerability in HAProxy's HTTP request parsing that allows HTTP
      request smuggling. Affects HAProxy versions before 2.0.25, 2.2.x
      before 2.2.17, 2.3.x before 2.3.14, and 2.4.x before 2.4.4.
    rationale: >
      CVE-2021-40346 allows an attacker to smuggle HTTP requests past
      HAProxy's parsing logic using a specially crafted Content-Length header
      with a specific integer overflow. This bypasses ACLs, WAF rules, and
      authentication checks, enabling direct access to backend systems.
      It is particularly dangerous because it undermines all proxy-level
      security controls.
    remediation: >
      Upgrade HAProxy to version 2.0.25, 2.2.17, 2.3.14, 2.4.4, or later
      to patch this vulnerability. As a temporary mitigation, add a rule to
      reject requests with multiple Content-Length headers:
      http-request deny if { req.hdr_cnt(content-length) gt 1 }
    references:
      nist:
        - SI-2
        - SI-10
        - RA-5
      owasp:
        - A06:2021 Vulnerable and Outdated Components
        - A03:2021 Injection
      stig:
        - SRG-APP-000454-WSR-000170
        - SRG-APP-000456-WSR-000187
    check_function: cve.check_request_smuggling_cve
    requires: version
