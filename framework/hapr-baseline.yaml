# HAPR Security Baseline - HAProxy Audit Framework
# Version: 1.0.0
# Last Updated: 2025-05-01
#
# This file defines all security checks performed by the HAPR audit tool.
# Each check maps to industry standards (NIST SP 800-53, OWASP, DISA STIG).

metadata:
  name: HAPR Security Baseline
  version: "1.0.0"
  description: >
    Comprehensive security baseline for HAProxy configurations.
    Covers process hardening, TLS, access control, headers, request handling,
    logging, information disclosure, timeouts, backend/frontend security,
    global settings, live TLS scanning, and known CVE detection.
  author: HAPR Project
  categories:
    - process
    - tls
    - access
    - headers
    - request
    - logging
    - disclosure
    - timeouts
    - backend
    - frontend
    - global_defaults
    - tls_live
    - cve
  severity_weights:
    critical: 10
    high: 7
    medium: 4
    low: 2
    info: 0
  tiers:
    baseline: "Minimum viable security - every deployment must pass"
    level1: "Standard production security"
    level2: "Enhanced security for sensitive environments"
    level3: "Maximum hardening for high-security environments"

checks:

  # ---------------------------------------------------------------------------
  # HAPR-PROC: Process Security
  # ---------------------------------------------------------------------------

  - id: HAPR-PROC-001
    title: Chroot Enabled
    category: process
    tier: baseline
    severity: high
    weight: 7
    description: >
      Verify that HAProxy is configured to chroot into a restricted directory,
      limiting filesystem access in the event of a compromise.
    rationale: >
      Running HAProxy in a chroot jail confines the process to a dedicated
      directory tree. If an attacker exploits a vulnerability, they cannot
      traverse the full filesystem to access sensitive data or binaries.
    remediation: >
      Add a chroot directive to the global section pointing to an empty,
      dedicated directory. Example: chroot /var/lib/haproxy
    references:
      nist:
        - SC-39
        - CM-7
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000141-WSR-000076
    check_function: process.check_chroot

  - id: HAPR-PROC-002
    title: Runs as Non-Root User
    category: process
    tier: baseline
    severity: critical
    weight: 10
    description: >
      Verify that HAProxy drops privileges and runs as a non-root user after
      binding to privileged ports.
    rationale: >
      Running network services as root grants the process unrestricted system
      access. If compromised, an attacker inherits full root privileges. HAProxy
      should drop to an unprivileged user immediately after startup.
    remediation: >
      Set the user directive in the global section to a dedicated non-root
      service account. Example: user haproxy
    references:
      nist:
        - AC-6
        - AC-6(2)
        - CM-7
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000141-WSR-000076
        - SRG-APP-000211-WSR-000030
    check_function: process.check_non_root_user

  - id: HAPR-PROC-003
    title: Group Directive Set
    category: process
    tier: level1
    severity: medium
    weight: 4
    description: >
      Verify that HAProxy is configured with a dedicated group to further
      restrict process permissions.
    rationale: >
      Setting a dedicated group ensures HAProxy cannot access files owned by
      other groups, reducing the blast radius of a compromise. Combined with
      the user directive, this enforces proper Unix permission boundaries.
    remediation: >
      Add a group directive in the global section. Example: group haproxy
    references:
      nist:
        - AC-6
        - AC-3
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000211-WSR-000030
    check_function: process.check_user_group

  - id: HAPR-PROC-004
    title: Ulimits Configured
    category: process
    tier: level2
    severity: low
    weight: 2
    description: >
      Verify that file descriptor ulimits are explicitly configured in the
      global section to prevent resource exhaustion.
    rationale: >
      HAProxy uses file descriptors for every connection. Without explicit
      ulimit settings, the process may hit OS defaults and drop legitimate
      connections during traffic spikes, leading to denial of service.
    remediation: >
      Set ulimit-n in the global section to a value appropriate for your
      expected connection count. Example: ulimit-n 65536
    references:
      nist:
        - SC-5
        - AU-5(1)
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: process.check_ulimits

  - id: HAPR-PROC-005
    title: Daemon Mode Configured
    category: process
    tier: baseline
    severity: low
    weight: 2
    description: >
      Verify that HAProxy is configured to run as a daemon process,
      detaching from the terminal and running in the background.
    rationale: >
      Running HAProxy in foreground mode is suitable for debugging but
      not for production. Daemon mode ensures the process runs as a
      proper background service, integrates with init systems, and
      prevents accidental termination when the controlling terminal closes.
    remediation: >
      Add the daemon directive to the global section. Example: daemon
    references:
      nist:
        - CM-6
        - CM-2
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: process.check_daemon_mode

  # ---------------------------------------------------------------------------
  # HAPR-TLS: TLS/SSL Configuration
  # ---------------------------------------------------------------------------

  - id: HAPR-TLS-001
    title: Minimum TLS Version 1.2
    category: tls
    tier: baseline
    severity: critical
    weight: 10
    description: >
      Verify that the configuration enforces TLS 1.2 as the minimum accepted
      protocol version, disabling TLS 1.0 and 1.1.
    rationale: >
      TLS 1.0 and 1.1 contain known cryptographic weaknesses including
      susceptibility to BEAST, POODLE, and other downgrade attacks. All major
      browsers and compliance frameworks require TLS 1.2 as the minimum.
    remediation: >
      Set ssl-default-bind-options to include no-sslv3 no-tlsv10 no-tlsv11,
      or use ssl-min-ver TLSv1.2 in HAProxy 2.x and later.
    references:
      nist:
        - SC-8
        - SC-8(1)
        - SC-13
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
        - SRG-APP-000442-WSR-000064
    check_function: tls.check_min_tls_version

  - id: HAPR-TLS-002
    title: No Weak Cipher Strings
    category: tls
    tier: baseline
    severity: critical
    weight: 10
    description: >
      Verify that the cipher configuration does not include known weak or
      broken cipher suites such as DES, RC4, MD5-based, NULL, or EXPORT
      ciphers.
    rationale: >
      Weak ciphers can be broken with feasible computational effort, allowing
      attackers to decrypt intercepted traffic. RC4 has known biases, DES has
      a 56-bit key, and EXPORT ciphers were intentionally weakened.
    remediation: >
      Configure ssl-default-bind-ciphers with a strong cipher string that
      excludes weak algorithms. Example:
      ssl-default-bind-ciphers ECDHE+AESGCM:DHE+AESGCM:!aNULL:!MD5:!DSS:!RC4:!DES:!3DES:!EXPORT
    references:
      nist:
        - SC-8(1)
        - SC-13
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
        - SRG-APP-000179-WSR-000110
    check_function: tls.check_no_weak_ciphers

  - id: HAPR-TLS-003
    title: SSL Default Bind Options Set
    category: tls
    tier: baseline
    severity: high
    weight: 7
    description: >
      Verify that ssl-default-bind-options is explicitly configured in the
      global section to enforce secure TLS defaults across all bind lines.
    rationale: >
      Without global ssl-default-bind-options, each bind line must individually
      specify TLS settings, increasing the risk of inconsistent or insecure
      configurations across frontends.
    remediation: >
      Add ssl-default-bind-options in the global section. Example:
      ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11 no-tls-tickets
    references:
      nist:
        - SC-8
        - CM-6
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
    check_function: tls.check_ssl_default_bind_options

  - id: HAPR-TLS-004
    title: SSL Default Bind Ciphers Set
    category: tls
    tier: level1
    severity: high
    weight: 7
    description: >
      Verify that ssl-default-bind-ciphers is explicitly configured in the
      global section to enforce a strong cipher suite across all bind lines.
    rationale: >
      A global cipher configuration ensures consistent cryptographic strength
      across all frontends. Without it, HAProxy falls back to OpenSSL defaults
      which may include weak ciphers depending on the library version.
    remediation: >
      Set ssl-default-bind-ciphers in the global section with a curated list
      of strong ciphers. Example:
      ssl-default-bind-ciphers ECDHE+AESGCM:DHE+AESGCM:!aNULL:!MD5:!DSS
    references:
      nist:
        - SC-8(1)
        - SC-13
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000179-WSR-000110
    check_function: tls.check_ssl_default_bind_ciphers

  - id: HAPR-TLS-005
    title: TLS 1.3 Ciphersuites Configured
    category: tls
    tier: level1
    severity: medium
    weight: 4
    description: >
      Verify that ssl-default-bind-ciphersuites is configured to specify
      the allowed TLS 1.3 cipher suites explicitly.
    rationale: >
      TLS 1.3 uses a separate ciphersuite directive from TLS 1.2. While all
      TLS 1.3 ciphers are currently considered strong, explicitly setting them
      ensures forward control and auditability as cryptographic standards evolve.
    remediation: >
      Set ssl-default-bind-ciphersuites in the global section. Example:
      ssl-default-bind-ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256
    references:
      nist:
        - SC-13
        - SC-8(1)
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000179-WSR-000110
    check_function: tls.check_ssl_default_bind_ciphersuites

  - id: HAPR-TLS-006
    title: HSTS Header Configured
    category: tls
    tier: level1
    severity: high
    weight: 7
    description: >
      Verify that HTTP Strict Transport Security (HSTS) is configured to
      instruct browsers to only connect via HTTPS.
    rationale: >
      Without HSTS, users may initially connect over plain HTTP and be
      vulnerable to man-in-the-middle attacks during the redirect to HTTPS.
      HSTS eliminates this window by instructing browsers to use HTTPS for
      all future requests.
    remediation: >
      Add an HSTS response header with a minimum max-age of 31536000 seconds.
      Example: http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"
    references:
      nist:
        - SC-8
        - SC-8(1)
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
        - SRG-APP-000015-WSR-000014
    check_function: tls.check_hsts_configured

  - id: HAPR-TLS-007
    title: DH Parameter Size at Least 2048 Bits
    category: tls
    tier: level1
    severity: medium
    weight: 4
    description: >
      Verify that the Diffie-Hellman parameter size is set to at least 2048
      bits to ensure adequate key exchange strength.
    rationale: >
      DH parameters smaller than 2048 bits are vulnerable to precomputation
      attacks such as Logjam. NIST recommends a minimum of 2048 bits for DH
      key exchange to provide adequate security through 2030.
    remediation: >
      Set tune.ssl.default-dh-param to at least 2048 in the global section.
      Example: tune.ssl.default-dh-param 2048
    references:
      nist:
        - SC-13
        - SC-12
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000179-WSR-000110
    check_function: tls.check_dh_param_size

  - id: HAPR-TLS-008
    title: TLS Session Tickets Disabled
    category: tls
    tier: level1
    severity: medium
    weight: 4
    description: >
      Verify that TLS session tickets are disabled via the no-tls-tickets
      option in ssl-default-bind-options or on individual bind lines.
    rationale: >
      TLS session tickets allow session resumption without server-side state,
      but the ticket encryption key is shared across all connections. If the
      server is compromised, all session tickets can be decrypted, breaking
      forward secrecy. Disabling tickets forces full handshakes or
      server-side session caching.
    remediation: >
      Add no-tls-tickets to ssl-default-bind-options in the global section.
      Example: ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11 no-tls-tickets
    references:
      nist:
        - SC-8(1)
        - SC-13
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
    check_function: tls.check_tls_session_tickets_disabled

  - id: HAPR-TLS-009
    title: SSL Default Server Options Set
    category: tls
    tier: level1
    severity: medium
    weight: 4
    description: >
      Verify that ssl-default-server-options is configured in the global
      section to enforce secure TLS defaults for backend server connections.
    rationale: >
      Without global ssl-default-server-options, each server line must
      individually specify TLS settings for backend connections, increasing
      the risk of inconsistent or insecure configurations. This directive
      centralizes backend TLS settings similar to how ssl-default-bind-options
      centralizes frontend TLS settings.
    remediation: >
      Add ssl-default-server-options in the global section. Example:
      ssl-default-server-options ssl-min-ver TLSv1.2
    references:
      nist:
        - SC-8
        - CM-6
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
    check_function: tls.check_ssl_default_server_options

  - id: HAPR-TLS-010
    title: OCSP Stapling Configured
    category: tls
    tier: level2
    severity: medium
    weight: 4
    description: >
      Verify that OCSP stapling is configured to provide certificate revocation
      status to clients without requiring them to contact the CA directly.
    rationale: >
      Without OCSP stapling, clients must contact the CA's OCSP responder
      independently, which adds latency and exposes browsing patterns. OCSP
      stapling embeds the revocation status in the TLS handshake, improving
      both privacy and performance.
    remediation: >
      Configure OCSP stapling on bind lines with 'ocsp-update on' or provide
      pre-fetched OCSP responses alongside certificates.
    references:
      nist:
        - SC-8(1)
        - SC-13
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
    check_function: tls.check_ocsp_stapling

  - id: HAPR-TLS-011
    title: FIPS-Approved Cipher Suites Only
    category: tls
    tier: level3
    severity: high
    weight: 7
    description: >
      Verify that only FIPS 140-2 approved cipher suites are configured,
      excluding non-approved algorithms such as CHACHA20, CAMELLIA, and SEED.
    rationale: >
      FIPS 140-2 compliance requires the use of NIST-approved cryptographic
      algorithms. Non-FIPS ciphers may be strong but are not certified for
      use in government or regulated environments.
    remediation: >
      Configure ssl-default-bind-ciphers to include only FIPS-approved
      algorithms such as AES-GCM with SHA-256/384 and ECDHE/DHE key exchange.
      Remove CHACHA20, CAMELLIA, SEED, and other non-FIPS ciphers.
    references:
      nist:
        - SC-13
        - SC-12
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000179-WSR-000110
        - SRG-APP-000439-WSR-000156
    check_function: tls.check_fips_ciphers

  - id: HAPR-MTLS-001
    title: Mutual TLS Client Verification
    category: tls
    tier: level3
    severity: high
    weight: 7
    description: >
      Verify that mutual TLS (mTLS) is configured with client certificate
      verification on SSL bind lines for zero-trust environments.
    rationale: >
      Mutual TLS ensures both server and client authenticate each other
      using certificates. This is essential for zero-trust architectures
      where every connection must be verified, preventing unauthorized
      clients from accessing services.
    remediation: >
      Add 'verify required' and 'ca-file <path>' to SSL bind lines.
      Example: bind :443 ssl crt /etc/haproxy/cert.pem verify required ca-file /etc/haproxy/ca.pem
    references:
      nist:
        - IA-3
        - IA-5(2)
        - SC-8(1)
      owasp:
        - A07:2021 Identification and Authentication Failures
      stig:
        - SRG-APP-000219-WSR-000036
        - SRG-APP-000427-WSR-000186
    check_function: tls.check_mtls_client_verification

  - id: HAPR-MTLS-002
    title: Client Certificate CRL Configured
    category: tls
    tier: level3
    severity: medium
    weight: 4
    description: >
      Verify that Certificate Revocation Lists (CRLs) are configured for
      client certificate verification to handle revoked certificates.
    rationale: >
      Without CRL checking, revoked client certificates may still be accepted
      for authentication. CRL files ensure that compromised or decommissioned
      client certificates are properly rejected.
    remediation: >
      Add 'crl-file <path>' to bind lines that use 'verify required'.
      Example: bind :443 ssl crt /etc/haproxy/cert.pem verify required ca-file /etc/haproxy/ca.pem crl-file /etc/haproxy/crl.pem
    references:
      nist:
        - IA-5(2)
        - SC-12
      owasp:
        - A07:2021 Identification and Authentication Failures
      stig:
        - SRG-APP-000175-WSR-000095
    check_function: tls.check_client_crl_configured

  # ---------------------------------------------------------------------------
  # HAPR-ACL: Access Control
  # ---------------------------------------------------------------------------

  - id: HAPR-ACL-001
    title: ACLs Defined in Frontends
    category: access
    tier: level1
    severity: medium
    weight: 4
    description: >
      Verify that frontend sections define access control lists (ACLs) to
      filter and route traffic based on request attributes.
    rationale: >
      ACLs are the primary mechanism in HAProxy for implementing access
      control policies. Frontends without ACLs pass all traffic to backends
      without any filtering, increasing exposure to malicious requests.
    remediation: >
      Define ACL rules in each frontend to filter traffic by source IP, path,
      headers, or other criteria. Example:
      acl internal_net src 10.0.0.0/8 192.168.0.0/16
    references:
      nist:
        - AC-3
        - AC-4
      owasp:
        - A01:2021 Broken Access Control
      stig:
        - SRG-APP-000315-WSR-000004
    check_function: access.check_acls_defined

  - id: HAPR-ACL-002
    title: Admin Paths Restricted
    category: access
    tier: level2
    severity: high
    weight: 7
    requires_mode: http
    description: >
      Verify that administrative paths such as /admin, /manager, and
      /haproxy?stats are restricted by IP address or authentication.
    rationale: >
      Administrative endpoints exposed without access restrictions allow
      attackers to manage or reconfigure the proxy, view sensitive operational
      data, or pivot to backend systems.
    remediation: >
      Use ACLs to restrict admin paths to trusted source IPs or require
      HTTP basic authentication. Example:
      acl admin_path path_beg /admin /manager
      acl trusted_src src 10.0.0.0/8
      http-request deny if admin_path !trusted_src
    references:
      nist:
        - AC-3
        - AC-6
        - AC-6(1)
      owasp:
        - A01:2021 Broken Access Control
      stig:
        - SRG-APP-000315-WSR-000004
        - SRG-APP-000141-WSR-000076
    check_function: access.check_admin_path_restricted

  - id: HAPR-ACL-003
    title: Rate Limiting Configured
    category: access
    tier: level1
    severity: high
    weight: 7
    description: >
      Verify that rate limiting is implemented using stick tables, ACLs,
      or external mechanisms to throttle excessive requests.
    rationale: >
      Without rate limiting, HAProxy is vulnerable to brute-force attacks,
      credential stuffing, and application-layer denial of service. Rate
      limiting is essential for protecting backend resources from abuse.
    remediation: >
      Implement rate limiting using stick tables with http_req_rate or
      conn_rate tracking. Example:
      stick-table type ip size 100k expire 30s store http_req_rate(10s)
      http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }
    references:
      nist:
        - SC-5
        - SI-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: access.check_rate_limiting

  - id: HAPR-ACL-004
    title: Stick Tables for Connection Tracking
    category: access
    tier: level1
    severity: medium
    weight: 4
    description: >
      Verify that stick tables are configured for connection and request
      tracking to enable abuse detection and rate limiting.
    rationale: >
      Stick tables maintain per-client state that enables HAProxy to detect
      anomalous traffic patterns, enforce rate limits, and support session
      persistence. Without them, abuse detection relies entirely on external
      systems.
    remediation: >
      Configure stick tables in relevant backends or frontends to track
      connection rates, request rates, or byte counters. Example:
      stick-table type ip size 200k expire 5m store conn_cur,conn_rate(3s),http_req_rate(10s)
    references:
      nist:
        - SC-5
        - AU-6
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: access.check_stick_tables

  - id: HAPR-ACL-005
    title: Stats Access Fully Restricted
    category: access
    tier: level1
    severity: high
    weight: 7
    description: >
      Verify that the HAProxy stats page, if enabled, is protected with
      authentication and/or IP-based access restrictions. Also checks that
      stats hide-version is enabled to prevent version disclosure and that
      the stats admin directive is restricted by ACL to prevent unauthorized
      administrative actions on the stats page.
    rationale: >
      The stats page exposes detailed operational information including server
      health, connection counts, error rates, and backend topology. Unrestricted
      access provides attackers with reconnaissance data for targeting backends.
      Exposing the HAProxy version on the stats page aids further reconnaissance,
      and an unprotected stats admin interface allows live manipulation of
      backend server states.
    remediation: >
      Restrict stats access with authentication, IP filtering, version hiding,
      and admin ACL. Example:
      stats auth admin:securepassword
      stats hide-version
      stats admin if LOCALHOST
      acl stats_allowed src 10.0.0.0/8
      http-request deny if !stats_allowed
    references:
      nist:
        - AC-3
        - AC-6
      owasp:
        - A01:2021 Broken Access Control
      stig:
        - SRG-APP-000315-WSR-000004
    check_function: access.check_stats_access_restricted

  - id: HAPR-ACL-006
    title: Userlist Passwords Hashed
    category: access
    tier: level1
    severity: high
    weight: 7
    description: >
      Verify that userlist passwords use crypt(3)-style hashing rather than
      the insecure-password directive which stores credentials in cleartext.
    rationale: >
      HAProxy userlists support two password storage methods: the password
      directive (which expects a crypt hash) and insecure-password (which
      stores plaintext). Cleartext passwords in configuration files are
      trivially compromised if the file is exposed through backups, version
      control, or unauthorized filesystem access.
    remediation: >
      Replace insecure-password with password and provide a crypt(3) hash.
      Generate hashes using mkpasswd. Example:
      mkpasswd -m sha-512 mypassword
      userlist myusers
        user admin password $6$rounds=5000$salt$hashedvalue
    references:
      nist:
        - IA-5
        - IA-5(1)
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000171-WSR-000100
    check_function: access.check_userlist_passwords

  - id: HAPR-ACL-007
    title: Source IP Restrictions on Admin Interfaces
    category: access
    tier: level1
    severity: high
    weight: 7
    description: >
      Verify that source IP restrictions are configured on administrative
      interfaces, stats pages, and management endpoints to limit access
      to trusted networks.
    rationale: >
      Administrative interfaces exposed to all source IPs are vulnerable
      to brute-force attacks, credential stuffing, and unauthorized access.
      Restricting access by source IP provides a strong network-layer defense
      even if authentication is compromised.
    remediation: >
      Add source IP-based ACLs to restrict admin access. Example:
      acl trusted_src src 10.0.0.0/8 192.168.0.0/16
      http-request deny if !trusted_src
    references:
      nist:
        - AC-3
        - AC-6
        - SC-7
      owasp:
        - A01:2021 Broken Access Control
      stig:
        - SRG-APP-000315-WSR-000004
        - SRG-APP-000141-WSR-000076
    check_function: access.check_source_ip_restrictions

  - id: HAPR-JWT-001
    title: JWT Signature Verification Enforced
    category: access
    tier: level3
    severity: high
    weight: 7
    description: >
      Verify that JWT (JSON Web Token) signature verification is enforced
      at the proxy level for API gateway configurations.
    rationale: >
      Without JWT verification at the proxy, unsigned or tampered tokens
      may reach backend services. HAProxy 2.5+ supports native JWT
      verification, and Lua scripts can provide similar functionality
      in older versions.
    remediation: >
      Configure JWT verification using HAProxy's native jwt_verify
      functionality or a Lua script. Ensure all API endpoints validate
      the Authorization header before forwarding requests.
    references:
      nist:
        - IA-2
        - IA-5
        - AC-3
      owasp:
        - A07:2021 Identification and Authentication Failures
      stig:
        - SRG-APP-000219-WSR-000036
    check_function: access.check_jwt_verification

  - id: HAPR-JWT-002
    title: JWT Algorithm Restriction (No alg:none)
    category: access
    tier: level3
    severity: critical
    weight: 10
    description: >
      Verify that JWT configurations restrict allowed signing algorithms
      and prevent the alg:none attack vector.
    rationale: >
      The JWT alg:none attack allows attackers to bypass signature
      verification entirely by specifying "none" as the algorithm.
      Restricting algorithms to specific approved values (RS256, ES256, etc.)
      prevents this critical attack vector.
    remediation: >
      Explicitly specify allowed JWT algorithms in verification configuration.
      Never accept 'none' as a valid algorithm. Example: verify using RS256 or ES256 only.
    references:
      nist:
        - SC-13
        - IA-5
      owasp:
        - A02:2021 Cryptographic Failures
        - A07:2021 Identification and Authentication Failures
      stig:
        - SRG-APP-000179-WSR-000110
    check_function: access.check_jwt_algorithm_restriction

  - id: HAPR-BOT-001
    title: Bot Detection Patterns Configured
    category: access
    tier: level3
    severity: medium
    weight: 4
    description: >
      Verify that bot detection patterns are configured to filter
      automated traffic based on User-Agent and behavioral patterns.
    rationale: >
      Automated bots can consume resources, scrape content, and probe
      for vulnerabilities. User-Agent filtering at the proxy level
      provides a first line of defense against known malicious bots
      and crawlers.
    remediation: >
      Add ACL rules to filter known bad User-Agent strings.
      Example: acl bad_bot hdr(User-Agent) -i -m sub bot crawler spider
      http-request deny if bad_bot
    references:
      nist:
        - SC-5
        - SI-4
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: access.check_bot_detection

  - id: HAPR-IPREP-001
    title: IP Reputation Integration Detected
    category: access
    tier: level3
    severity: medium
    weight: 4
    description: >
      Verify that IP reputation or threat intelligence integration is
      configured to block known malicious sources.
    rationale: >
      IP reputation services (CrowdSec, fail2ban, commercial threat
      intelligence feeds) provide dynamic blocking of known malicious
      IP addresses, significantly reducing attack surface from known
      threat actors.
    remediation: >
      Integrate an IP reputation service such as CrowdSec bouncer or
      configure map-based IP blocklists that are periodically updated.
      Example: http-request deny if { src -f /etc/haproxy/blocklist.map }
    references:
      nist:
        - SI-4
        - SC-7(5)
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000315-WSR-000004
    check_function: access.check_ip_reputation_integration

  - id: HAPR-API-001
    title: API Authentication Enforcement
    category: access
    tier: level3
    severity: high
    weight: 7
    description: >
      Verify that API endpoints enforce authentication by requiring
      valid credentials before processing requests.
    rationale: >
      Unauthenticated API endpoints expose backend services to abuse,
      data leakage, and unauthorized access. Enforcing authentication
      at the proxy level ensures no request reaches backends without
      valid credentials.
    remediation: >
      Add authentication requirements for API paths using ACLs and
      deny rules. Example:
      acl api_path path_beg /api /v1 /v2
      acl has_auth req.hdr(Authorization) -m found
      http-request deny if api_path !has_auth
    references:
      nist:
        - IA-2
        - AC-3
        - AC-17
      owasp:
        - A07:2021 Identification and Authentication Failures
        - A01:2021 Broken Access Control
      stig:
        - SRG-APP-000219-WSR-000036
    check_function: access.check_api_authentication

  - id: HAPR-API-002
    title: Per-API Rate Limiting
    category: access
    tier: level3
    severity: medium
    weight: 4
    description: >
      Verify that API endpoints have dedicated rate limiting to prevent
      abuse and ensure fair resource allocation.
    rationale: >
      API endpoints are common targets for brute-force attacks, credential
      stuffing, and resource exhaustion. Per-API rate limiting ensures
      that abuse of one endpoint does not affect others and prevents
      automated attacks.
    remediation: >
      Configure stick-tables and rate limiting specific to API paths.
      Example:
      stick-table type ip size 100k expire 30s store http_req_rate(10s)
      acl api_path path_beg /api
      http-request track-sc0 src if api_path
      http-request deny deny_status 429 if api_path { sc_http_req_rate(0) gt 100 }
    references:
      nist:
        - SC-5
        - SC-5(2)
      owasp:
        - A04:2021 Insecure Design
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: access.check_api_rate_limiting

  # ---------------------------------------------------------------------------
  # HAPR-HDR: HTTP Security Headers
  # ---------------------------------------------------------------------------

  - id: HAPR-HDR-001
    title: X-Frame-Options Header Set
    category: headers
    tier: level1
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that the X-Frame-Options header is set to DENY or SAMEORIGIN
      to prevent clickjacking attacks.
    rationale: >
      Without X-Frame-Options, the site can be embedded in iframes on
      malicious pages, enabling clickjacking where users unknowingly interact
      with the proxied application through a disguised interface.
    remediation: >
      Add the X-Frame-Options header in frontend or backend configuration.
      Example: http-response set-header X-Frame-Options DENY
    references:
      nist:
        - SI-10
        - SC-18
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: headers.check_x_frame_options

  - id: HAPR-HDR-002
    title: Content-Security-Policy Header Set
    category: headers
    tier: level1
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that a Content-Security-Policy header is configured to restrict
      the sources from which content can be loaded.
    rationale: >
      CSP is the primary defense against cross-site scripting and data
      injection attacks. It restricts which domains can serve scripts, styles,
      images, and other resources, significantly reducing the attack surface
      for XSS.
    remediation: >
      Add a Content-Security-Policy header. Start with a restrictive policy
      and relax as needed. Example:
      http-response set-header Content-Security-Policy "default-src 'self'; script-src 'self'"
    references:
      nist:
        - SI-10
        - SC-18
      owasp:
        - A03:2021 Injection
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: headers.check_csp_header

  - id: HAPR-HDR-003
    title: X-Content-Type-Options Header Set
    category: headers
    tier: level1
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that the X-Content-Type-Options header is set to nosniff to
      prevent MIME type confusion attacks.
    rationale: >
      Without nosniff, browsers may attempt to guess the MIME type of a
      response, potentially interpreting data files as executable content.
      This enables attacks where malicious content is served with an
      innocuous Content-Type.
    remediation: >
      Add the X-Content-Type-Options header. Example:
      http-response set-header X-Content-Type-Options nosniff
    references:
      nist:
        - SI-10
        - SC-18
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: headers.check_x_content_type_options

  - id: HAPR-HDR-004
    title: Referrer-Policy Header Set
    category: headers
    tier: level1
    severity: low
    weight: 2
    requires_mode: http
    description: >
      Verify that a Referrer-Policy header is configured to control how
      much referrer information is sent with requests.
    rationale: >
      By default, browsers send the full URL as a referrer to third-party
      sites, potentially leaking sensitive path components, query parameters,
      or session tokens contained in URLs.
    remediation: >
      Set a restrictive Referrer-Policy header. Example:
      http-response set-header Referrer-Policy strict-origin-when-cross-origin
    references:
      nist:
        - SC-8
        - SI-11
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: headers.check_referrer_policy

  - id: HAPR-HDR-005
    title: Permissions-Policy Header Set
    category: headers
    tier: level2
    severity: low
    weight: 2
    requires_mode: http
    description: >
      Verify that a Permissions-Policy header is configured to restrict
      access to browser features and APIs.
    rationale: >
      Permissions-Policy allows control over which browser features (camera,
      microphone, geolocation, etc.) can be used by the page and its embedded
      content. Without it, embedded iframes may access sensitive device
      capabilities.
    remediation: >
      Add a Permissions-Policy header restricting unnecessary features.
      Example:
      http-response set-header Permissions-Policy "camera=(), microphone=(), geolocation=()"
    references:
      nist:
        - SC-18
        - AC-4
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: headers.check_permissions_policy

  - id: HAPR-HDR-006
    title: X-XSS-Protection Not Misconfigured
    category: headers
    tier: level2
    severity: low
    weight: 2
    requires_mode: http
    description: >
      Verify that the X-XSS-Protection header is either absent, set to 0,
      or not set to 1; mode=block. This header is deprecated and enabling
      it can introduce vulnerabilities in older browsers.
    rationale: >
      The X-XSS-Protection header is deprecated and its filter has been
      removed from modern browsers. Setting it to 1 or 1; mode=block can
      actually introduce cross-site leak vulnerabilities in older browsers
      that still implement the XSS Auditor. CSP should be used instead.
    remediation: >
      Either remove the X-XSS-Protection header entirely or set it to 0.
      Example: http-response set-header X-XSS-Protection "0"
      Rely on Content-Security-Policy for XSS mitigation instead.
    references:
      nist:
        - SI-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: headers.check_x_xss_protection

  - id: HAPR-HDR-007
    title: Cross-Origin-Opener-Policy Header Set
    category: headers
    tier: level1
    severity: low
    weight: 2
    requires_mode: http
    description: >
      Verify that the Cross-Origin-Opener-Policy (COOP) header is configured
      to isolate the browsing context from cross-origin windows.
    rationale: >
      COOP prevents cross-origin windows from accessing the document's
      browsing context, mitigating Spectre-class side-channel attacks and
      cross-origin information leaks. It is part of the OWASP recommended
      security header set.
    remediation: >
      Add the COOP header. Example:
      http-response set-header Cross-Origin-Opener-Policy same-origin
    references:
      nist:
        - SC-18
        - AC-4
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: headers.check_cross_origin_opener_policy

  - id: HAPR-HDR-008
    title: Cross-Origin-Embedder-Policy Header Set
    category: headers
    tier: level1
    severity: low
    weight: 2
    requires_mode: http
    description: >
      Verify that the Cross-Origin-Embedder-Policy (COEP) header is configured
      to control which cross-origin resources can be loaded.
    rationale: >
      COEP prevents a document from loading cross-origin resources that do
      not explicitly grant permission via CORS or CORP headers. Combined
      with COOP, it enables cross-origin isolation which is required for
      SharedArrayBuffer and high-resolution timers, and mitigates
      Spectre-class attacks.
    remediation: >
      Add the COEP header. Example:
      http-response set-header Cross-Origin-Embedder-Policy require-corp
    references:
      nist:
        - SC-18
        - AC-4
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: headers.check_cross_origin_embedder_policy

  - id: HAPR-HDR-009
    title: Cross-Origin-Resource-Policy Set
    category: headers
    tier: level2
    severity: low
    weight: 2
    description: >
      Verify that the Cross-Origin-Resource-Policy (CORP) header is set to
      control which origins can embed or load resources from this site.
    rationale: >
      The Cross-Origin-Resource-Policy header prevents other origins from
      reading resources served by this server. Combined with COOP and COEP,
      it completes cross-origin isolation and mitigates data leakage via
      cross-origin reads.
    remediation: >
      Add a Cross-Origin-Resource-Policy response header. Example:
      http-response set-header Cross-Origin-Resource-Policy same-origin
    references:
      nist:
        - SC-8
        - AC-4
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: headers.check_cross_origin_resource_policy

  # ---------------------------------------------------------------------------
  # HAPR-REQ: Request Handling
  # ---------------------------------------------------------------------------

  - id: HAPR-REQ-001
    title: Maximum Request Body Size Limited
    category: request
    tier: level1
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that the maximum allowed request body size is explicitly limited
      to prevent resource exhaustion from oversized payloads.
    rationale: >
      Without body size limits, an attacker can send extremely large request
      bodies to exhaust memory and disk resources on HAProxy or backend
      servers, causing denial of service. This also mitigates some buffer
      overflow attempts.
    remediation: >
      Set a maximum body size appropriate for your application. Example:
      http-request deny deny_status 413 if { req.body_size gt 10485760 }
    references:
      nist:
        - SC-5
        - SI-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: request.check_max_body_size

  - id: HAPR-REQ-002
    title: URL Length Limits Configured
    category: request
    tier: level2
    severity: low
    weight: 2
    requires_mode: http
    description: >
      Verify that URL length limits are configured to reject abnormally
      long request URIs that may indicate attacks.
    rationale: >
      Extremely long URLs can be used for buffer overflow attempts, denial
      of service, or to bypass security filters. Limiting URL length to a
      reasonable value reduces the attack surface.
    remediation: >
      Configure tune.http.maxuri in the global section or use an ACL to
      reject long URLs. Example:
      http-request deny deny_status 414 if { url_len gt 8192 }
    references:
      nist:
        - SI-10
        - SC-5
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: request.check_url_length_limits

  - id: HAPR-REQ-003
    title: HTTP Method Filtering
    category: request
    tier: level1
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that only required HTTP methods are allowed and dangerous or
      unnecessary methods such as TRACE, DELETE, and OPTIONS are restricted.
    rationale: >
      The TRACE method can be exploited for cross-site tracing attacks to
      steal credentials. Unrestricted methods like PUT and DELETE may allow
      unauthorized data modification on misconfigured backends. Only methods
      required by the application should be permitted.
    remediation: >
      Create an ACL to whitelist allowed methods and deny all others.
      Example:
      acl valid_method method GET HEAD POST
      http-request deny if !valid_method
    references:
      nist:
        - CM-7
        - AC-3
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000141-WSR-000076
        - SRG-APP-000315-WSR-000004
    check_function: request.check_method_filtering

  - id: HAPR-REQ-004
    title: Request Header Size Limits
    category: request
    tier: level2
    severity: low
    weight: 2
    requires_mode: http
    description: >
      Verify that request header size limits are configured to prevent
      abuse through oversized headers.
    rationale: >
      Large headers can be used for denial of service, smuggling attacks,
      or to exploit parsing vulnerabilities in HAProxy or backend servers.
      Reasonable limits protect against these attack vectors.
    remediation: >
      Set tune.http.maxhdr and tune.bufsize in the global section. Example:
      tune.http.maxhdr 101
      tune.bufsize 16384
    references:
      nist:
        - SC-5
        - SI-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: request.check_request_header_limits

  - id: HAPR-REQ-005
    title: HTTP Request Smuggling Prevention
    category: request
    tier: level1
    severity: high
    weight: 7
    requires_mode: http
    description: >
      Verify that HTTP request smuggling prevention measures are configured,
      such as option httpclose, duplicate Content-Length/Transfer-Encoding
      header detection, or HTX mode.
    rationale: >
      HTTP request smuggling exploits discrepancies between how HAProxy and
      backend servers parse HTTP requests, allowing attackers to bypass ACLs,
      WAF rules, and authentication. Prevention measures like rejecting
      duplicate Content-Length headers and enabling HTX mode close these
      attack vectors.
    remediation: >
      Add smuggling prevention rules. Example:
      http-request deny if { req.hdr_cnt(content-length) gt 1 }
      http-request deny if { req.hdr_cnt(transfer-encoding) gt 1 }
      Or use option httpclose to force connection-level isolation.
    references:
      nist:
        - SI-10
        - SC-8
      owasp:
        - A03:2021 Injection
      stig:
        - SRG-APP-000251-WSR-000157
        - SRG-APP-000454-WSR-000170
    check_function: request.check_http_smuggling_prevention

  - id: HAPR-H2-001
    title: HTTP/2 Stream Limits Configured
    category: request
    tier: level3
    severity: medium
    weight: 4
    description: >
      Verify that HTTP/2 stream limits are configured to prevent resource
      exhaustion through excessive concurrent streams.
    rationale: >
      HTTP/2 multiplexes many streams over a single connection. Without
      limits on concurrent streams, frame size, or window size, an attacker
      can exhaust server resources with minimal connections. The Rapid Reset
      attack (CVE-2023-44487) exploits unlimited stream creation.
    remediation: >
      Set HTTP/2 tuning parameters in the global section.
      Example: tune.h2.max-concurrent-streams 100
    references:
      nist:
        - SC-5
        - SC-5(2)
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: request.check_h2_stream_limits

  - id: HAPR-H2-002
    title: H2C Smuggling Prevention
    category: request
    tier: level3
    severity: high
    weight: 7
    description: >
      Verify that HTTP/2 cleartext (h2c) upgrades are prevented or
      restricted to mitigate request smuggling attacks.
    rationale: >
      H2C allows HTTP/2 without TLS via the Upgrade header. Attackers
      can exploit h2c upgrade mechanisms to smuggle requests past
      security controls. Binding h2 only over TLS or blocking h2c
      upgrade requests prevents this attack vector.
    remediation: >
      Either ensure HTTP/2 is only available over TLS (bind with ssl and
      alpn h2), or add deny rules for h2c upgrades:
      http-request deny if { req.hdr(Upgrade) -i h2c }
    references:
      nist:
        - SC-8
        - SI-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000251-WSR-000157
    check_function: request.check_h2c_smuggling_prevention

  # ---------------------------------------------------------------------------
  # HAPR-LOG: Logging & Monitoring
  # ---------------------------------------------------------------------------

  - id: HAPR-LOG-001
    title: Log Directive Present
    category: logging
    tier: baseline
    severity: high
    weight: 7
    description: >
      Verify that at least one log directive is configured in the global
      section to enable event logging.
    rationale: >
      Without logging, security incidents, errors, and performance issues
      cannot be detected, investigated, or correlated. Logging is a
      foundational requirement for security monitoring, incident response,
      and compliance.
    remediation: >
      Add a log directive pointing to a syslog server or local socket.
      Example: log 127.0.0.1:514 local0
    references:
      nist:
        - AU-2
        - AU-3
        - AU-12
      owasp:
        - A09:2021 Security Logging and Monitoring Failures
      stig:
        - SRG-APP-000092-WSR-000055
        - SRG-APP-000095-WSR-000056
    check_function: logging_checks.check_logging_configured

  - id: HAPR-LOG-002
    title: Detailed Log Format Configured
    category: logging
    tier: level1
    severity: medium
    weight: 4
    description: >
      Verify that the log format includes sufficient detail for security
      analysis, such as client IP, request method, URL, status code, and
      timing information.
    rationale: >
      Default log formats may omit critical fields needed for security
      investigation. Detailed logging enables correlation of events, detection
      of attack patterns, and forensic analysis after incidents.
    remediation: >
      Configure a custom log-format that includes security-relevant fields.
      Example:
      log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
    references:
      nist:
        - AU-3
        - AU-3(1)
        - AU-8
      owasp:
        - A09:2021 Security Logging and Monitoring Failures
      stig:
        - SRG-APP-000095-WSR-000056
        - SRG-APP-000096-WSR-000057
    check_function: logging_checks.check_log_format

  - id: HAPR-LOG-004
    title: Appropriate Log Level
    category: logging
    tier: level1
    severity: low
    weight: 2
    description: >
      Verify that the log level is set appropriately, capturing sufficient
      detail without excessive noise that could obscure security events.
    rationale: >
      A log level that is too low (e.g., emerg) will miss important security
      events. A level that is too high (e.g., debug) in production generates
      excessive volume that can fill disks, degrade performance, and make
      analysis difficult.
    remediation: >
      Set the log level to info or notice for production environments.
      Use warning or higher only if log volume is carefully managed.
      Example: log 127.0.0.1:514 local0 info
    references:
      nist:
        - AU-2
        - AU-5
      owasp:
        - A09:2021 Security Logging and Monitoring Failures
      stig:
        - SRG-APP-000092-WSR-000055
    check_function: logging_checks.check_log_level

  - id: HAPR-LOG-005
    title: HTTP or TCP Log Option Enabled
    category: logging
    tier: level1
    severity: medium
    weight: 4
    description: >
      Verify that option httplog or option tcplog is enabled to capture
      protocol-level details in log entries.
    rationale: >
      Without httplog or tcplog, HAProxy uses a minimal log format that
      omits request details, status codes, and timing metrics. These details
      are essential for detecting web attacks, troubleshooting issues, and
      meeting audit requirements.
    remediation: >
      Enable the appropriate log option in defaults or each frontend/backend.
      Example: option httplog
    references:
      nist:
        - AU-3
        - AU-12
      owasp:
        - A09:2021 Security Logging and Monitoring Failures
      stig:
        - SRG-APP-000095-WSR-000056
    check_function: logging_checks.check_httplog_or_tcplog

  - id: HAPR-LOG-006
    title: Dontlognull Option Enabled
    category: logging
    tier: baseline
    severity: low
    weight: 2
    description: >
      Verify that option dontlognull is configured to suppress logging of
      connections that close without sending any data.
    rationale: >
      Without dontlognull, health check probes, port scans, and idle
      connections generate noise in log files, making it harder to identify
      real security events. Enabling this option reduces log volume and
      improves signal-to-noise ratio for security monitoring.
    remediation: >
      Add option dontlognull to the defaults section. Example:
      defaults
        option dontlognull
    references:
      nist:
        - AU-2
        - AU-5
      owasp:
        - A09:2021 Security Logging and Monitoring Failures
      stig:
        - SRG-APP-000092-WSR-000055
    check_function: logging_checks.check_dontlognull

  - id: HAPR-LOG-007
    title: Remote Syslog Configured
    category: logging
    tier: level1
    severity: medium
    weight: 4
    description: >
      Verify that at least one log directive sends logs to a remote syslog
      server rather than only to a local socket or file.
    rationale: >
      Local-only logging is vulnerable to log tampering if the system is
      compromised. Remote syslog ensures audit logs are stored on a
      separate system where they cannot be easily modified or deleted by
      an attacker who has compromised the HAProxy host.
    remediation: >
      Configure a remote syslog target in the global section. Example:
      log 10.0.0.5:514 local0 info
    references:
      nist:
        - AU-4
        - AU-9
        - AU-9(2)
      owasp:
        - A09:2021 Security Logging and Monitoring Failures
      stig:
        - SRG-APP-000092-WSR-000055
        - SRG-APP-000125-WSR-000071
    check_function: logging_checks.check_remote_syslog

  # ---------------------------------------------------------------------------
  # HAPR-INF: Information Disclosure
  # ---------------------------------------------------------------------------

  - id: HAPR-INF-001
    title: Server Header Removed
    category: disclosure
    tier: baseline
    severity: high
    weight: 7
    requires_mode: http
    description: >
      Verify that the Server response header is removed or replaced to
      prevent disclosure of backend server software and versions.
    rationale: >
      The Server header typically reveals the backend web server software
      and version, giving attackers specific version information to search
      for known vulnerabilities. Removing it forces attackers to use more
      detectable fingerprinting techniques.
    remediation: >
      Remove or overwrite the Server header using a response rule.
      Example: http-response del-header Server
    references:
      nist:
        - SC-8
        - SI-11
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000266-WSR-000160
    check_function: disclosure.check_server_header_removed

  - id: HAPR-INF-002
    title: Custom Error Pages Configured
    category: disclosure
    tier: level1
    severity: medium
    weight: 4
    description: >
      Verify that custom error pages are configured to replace default
      HAProxy error responses that may reveal software details.
    rationale: >
      Default error pages often include the software name and version,
      internal server details, or stack traces. Custom error pages present
      a consistent user experience while preventing information leakage.
    remediation: >
      Configure custom error files for common HTTP error codes. Example:
      errorfile 400 /etc/haproxy/errors/400.http
      errorfile 403 /etc/haproxy/errors/403.http
      errorfile 500 /etc/haproxy/errors/500.http
      errorfile 502 /etc/haproxy/errors/502.http
      errorfile 503 /etc/haproxy/errors/503.http
    references:
      nist:
        - SI-11
        - SC-8
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000266-WSR-000160
    check_function: disclosure.check_custom_error_pages

  - id: HAPR-INF-003
    title: Version Information Hidden
    category: disclosure
    tier: level1
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that HAProxy version information is not disclosed in HTTP
      headers, error pages, or other responses.
    rationale: >
      Disclosing the exact HAProxy version enables attackers to identify
      specific vulnerabilities that affect that version. Hiding version
      information is a simple defense-in-depth measure that increases the
      cost of reconnaissance.
    remediation: >
      Ensure no version strings are exposed in headers or error pages.
      Remove or replace any headers that include HAProxy version details.
      Example: http-response del-header X-Powered-By
    references:
      nist:
        - SI-11
        - CM-7
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000266-WSR-000160
    check_function: disclosure.check_version_hidden

  - id: HAPR-INF-004
    title: Stats Page Version Hidden
    category: disclosure
    tier: level1
    severity: low
    weight: 2
    description: >
      Verify that the stats page is configured with stats hide-version to
      prevent HAProxy version disclosure on the statistics page.
    rationale: >
      The HAProxy stats page displays the version number by default. Even
      with authentication, the version disclosure provides useful
      reconnaissance data if credentials are compromised or the page is
      accidentally exposed.
    remediation: >
      Add stats hide-version in the stats configuration. Example:
      stats hide-version
    references:
      nist:
        - SI-11
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000266-WSR-000160
    check_function: disclosure.check_stats_version_hidden

  - id: HAPR-INF-005
    title: X-Forwarded-For Spoofing Prevention
    category: disclosure
    tier: level1
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that X-Forwarded-For header spoofing is prevented when option
      forwardfor is in use, by deleting or resetting the client-supplied
      X-Forwarded-For header before HAProxy adds its own.
    rationale: >
      When option forwardfor is enabled, HAProxy appends the client IP to
      the X-Forwarded-For header. However, clients can supply a forged
      X-Forwarded-For header, causing backends to trust the spoofed IP for
      access control, rate limiting, or audit logging. Deleting the header
      before appending prevents this attack.
    remediation: >
      Delete the client-supplied X-Forwarded-For before enabling forwardfor.
      Example:
      http-request del-header X-Forwarded-For
      option forwardfor
    references:
      nist:
        - SI-10
        - SC-8
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000266-WSR-000160
    check_function: disclosure.check_xff_spoofing_prevention

  # ---------------------------------------------------------------------------
  # HAPR-TMO: Timeout Configuration
  # ---------------------------------------------------------------------------

  - id: HAPR-TMO-001
    title: Client Timeout Set
    category: timeouts
    tier: baseline
    severity: high
    weight: 7
    description: >
      Verify that the client timeout (timeout client) is explicitly set
      to limit how long HAProxy waits for data from the client.
    rationale: >
      Without a client timeout, slow or abandoned connections remain open
      indefinitely, consuming file descriptors and memory. Attackers can
      exploit this with slowloris-style attacks to exhaust connection
      capacity and cause denial of service.
    remediation: >
      Set a client timeout appropriate for your application. Example:
      timeout client 30s
    references:
      nist:
        - SC-5
        - SC-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
        - SRG-APP-000295-WSR-000134
    check_function: timeouts.check_client_timeout

  - id: HAPR-TMO-002
    title: Server Timeout Set
    category: timeouts
    tier: baseline
    severity: high
    weight: 7
    description: >
      Verify that the server timeout (timeout server) is explicitly set
      to limit how long HAProxy waits for a response from backends.
    rationale: >
      Without a server timeout, requests to unresponsive backends hold
      connections open indefinitely. This wastes proxy resources, prevents
      failover to healthy backends, and can cascade into broader service
      degradation.
    remediation: >
      Set a server timeout appropriate for your backend response times.
      Example: timeout server 30s
    references:
      nist:
        - SC-5
        - SC-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000295-WSR-000134
    check_function: timeouts.check_server_timeout

  - id: HAPR-TMO-003
    title: Connect Timeout Set
    category: timeouts
    tier: baseline
    severity: high
    weight: 7
    description: >
      Verify that the connection timeout (timeout connect) is explicitly
      set to limit how long HAProxy waits to establish a backend connection.
    rationale: >
      Without a connect timeout, HAProxy waits indefinitely for backend
      connections that may never complete due to network issues or overloaded
      servers. This ties up proxy resources and delays failover to other
      backends.
    remediation: >
      Set a connect timeout appropriate for your network topology. Example:
      timeout connect 5s
    references:
      nist:
        - SC-5
        - SC-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000295-WSR-000134
    check_function: timeouts.check_connect_timeout

  - id: HAPR-TMO-004
    title: HTTP Request Timeout Set
    category: timeouts
    tier: baseline
    severity: high
    weight: 7
    description: >
      Verify that the HTTP request timeout (timeout http-request) is set
      to limit how long HAProxy waits for a complete HTTP request.
    rationale: >
      The http-request timeout is critical for defending against slowloris
      attacks, where clients send headers very slowly to hold connections
      open. Without this timeout, a small number of attackers can exhaust
      all available connections.
    remediation: >
      Set a http-request timeout to limit initial request time. Example:
      timeout http-request 10s
    references:
      nist:
        - SC-5
        - SI-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: timeouts.check_http_request_timeout

  - id: HAPR-TMO-005
    title: Timeout Values Are Reasonable
    category: timeouts
    tier: level1
    severity: medium
    weight: 4
    description: >
      Verify that timeout values are set to reasonable durations and are
      not excessively long, which would negate their protective purpose.
    rationale: >
      Timeouts that are set to extremely long durations (e.g., hours or
      days) provide little protection against resource exhaustion or
      slowloris attacks. Timeouts should balance application requirements
      with security, typically not exceeding a few minutes for most values.
    remediation: >
      Review all timeout values and ensure they are appropriate. General
      guidelines: connect 5-10s, client 30-60s, server 30-60s,
      http-request 5-15s. Adjust based on application needs but avoid
      values exceeding 300s without specific justification.
    references:
      nist:
        - SC-5
        - SC-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000295-WSR-000134
    check_function: timeouts.check_timeout_values_reasonable

  - id: HAPR-TMO-006
    title: HTTP Keep-Alive Timeout Set
    category: timeouts
    tier: baseline
    severity: medium
    weight: 4
    description: >
      Verify that the HTTP keep-alive timeout (timeout http-keep-alive) is
      explicitly set to limit idle keep-alive connection persistence.
    rationale: >
      Without an http-keep-alive timeout, idle connections from keep-alive
      requests may persist for the full client timeout duration, wasting
      resources and increasing exposure to slow-rate attacks. A short
      keep-alive timeout releases idle connections quickly while still
      allowing connection reuse for bursts of requests.
    remediation: >
      Set an http-keep-alive timeout appropriate for your application.
      Example: timeout http-keep-alive 5s
    references:
      nist:
        - SC-5
        - SC-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000295-WSR-000134
    check_function: timeouts.check_http_keepalive_timeout

  # ---------------------------------------------------------------------------
  # HAPR-BKD: Backend Security
  # ---------------------------------------------------------------------------

  - id: HAPR-BKD-001
    title: Health Checks Configured
    category: backend
    tier: level1
    severity: high
    weight: 7
    description: >
      Verify that backend server health checks are configured to detect
      and remove unhealthy servers from the load balancing rotation.
    rationale: >
      Without health checks, HAProxy continues sending traffic to failed
      or compromised backends, resulting in errors for users and potential
      security issues if a compromised server serves malicious content.
    remediation: >
      Enable health checks on backend servers using the check keyword and
      configure appropriate intervals. Example:
      server web1 10.0.0.1:80 check inter 5s fall 3 rise 2
    references:
      nist:
        - SC-5
        - SI-6
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: backend.check_health_checks

  - id: HAPR-BKD-002
    title: Connection Limits on Backend Servers
    category: backend
    tier: level2
    severity: medium
    weight: 4
    description: >
      Verify that per-server connection limits (maxconn) are configured on
      backend servers to prevent overloading individual hosts.
    rationale: >
      Without connection limits, a single backend server may receive more
      connections than it can handle, leading to degraded performance or
      crashes. Connection limits also help contain the impact if one server
      is slower due to compromise or resource issues.
    remediation: >
      Set maxconn on individual backend servers. Example:
      server web1 10.0.0.1:80 check maxconn 500
    references:
      nist:
        - SC-5
        - SC-6
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: backend.check_connection_limits

  - id: HAPR-BKD-003
    title: Backend SSL/TLS to Servers
    category: backend
    tier: level2
    severity: medium
    weight: 4
    description: >
      Verify that backend connections to servers use SSL/TLS to encrypt
      traffic between HAProxy and backend hosts.
    rationale: >
      Unencrypted backend connections expose request and response data to
      network sniffing on the backend network. If the backend network is
      compromised, an attacker can intercept sensitive data including
      authentication tokens and personal information.
    remediation: >
      Enable SSL on backend server lines. Example:
      server web1 10.0.0.1:443 ssl verify required ca-file /etc/ssl/certs/ca-bundle.crt check
    references:
      nist:
        - SC-8
        - SC-8(1)
        - SC-23
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
    check_function: backend.check_backend_ssl

  - id: HAPR-BKD-004
    title: Cookie Attributes Set Securely
    category: backend
    tier: level1
    severity: medium
    weight: 4
    description: >
      Verify that session persistence cookies set by HAProxy include the
      Secure, HttpOnly, and SameSite attributes.
    rationale: >
      HAProxy persistence cookies without Secure can be sent over plain
      HTTP, leaking session information. Without HttpOnly, cookies are
      accessible to JavaScript, enabling theft via XSS. Without SameSite,
      cookies may be sent in cross-site requests, enabling CSRF attacks.
    remediation: >
      Configure cookie attributes in backend sections. Example:
      cookie SERVERID insert indirect nocache httponly secure attr SameSite=Strict
    references:
      nist:
        - SC-8
        - SC-23
      owasp:
        - A01:2021 Broken Access Control
      stig:
        - SRG-APP-000439-WSR-000156
        - SRG-APP-000023-WSR-000012
    check_function: backend.check_cookie_security

  - id: HAPR-BKD-005
    title: Retry and Redispatch Configured
    category: backend
    tier: level2
    severity: low
    weight: 2
    description: >
      Verify that retry and redispatch options are configured to handle
      backend failures gracefully.
    rationale: >
      Without retries and redispatch, a single backend failure results in
      an immediate error to the user. Proper retry logic with redispatch
      allows HAProxy to transparently failover to a healthy server, improving
      availability and resilience against targeted backend attacks.
    remediation: >
      Configure retries and enable redispatch in the defaults or backend
      section. Example:
      retries 3
      option redispatch
    references:
      nist:
        - SC-5
        - CP-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: backend.check_retry_redispatch

  - id: HAPR-BKD-006
    title: Backend SSL Certificate Verification
    category: backend
    tier: level1
    severity: high
    weight: 7
    description: >
      Verify that backend servers using SSL have certificate verification
      enabled with verify required and a ca-file to validate the server
      certificate chain.
    rationale: >
      SSL connections to backends without certificate verification are
      vulnerable to man-in-the-middle attacks. An attacker on the backend
      network can present a fraudulent certificate and intercept all traffic
      between HAProxy and the backend server, capturing sensitive data
      including authentication tokens and personal information.
    remediation: >
      Enable certificate verification on backend server lines. Example:
      server web1 10.0.0.1:443 ssl verify required ca-file /etc/ssl/certs/ca-bundle.crt
    references:
      nist:
        - SC-8
        - SC-8(1)
        - IA-5(2)
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
        - SRG-APP-000427-WSR-000186
    check_function: backend.check_backend_ssl_verification

  - id: HAPR-CACHE-001
    title: Cache Security Controls
    category: backend
    tier: level2
    severity: medium
    weight: 4
    description: >
      Verify that HAProxy cache configuration includes security controls
      such as size limits, max-age restrictions, and cache-control headers
      to prevent cache poisoning and data leakage.
    rationale: >
      Improperly configured caches can serve stale or poisoned content,
      leak sensitive data between users, or be used to amplify attacks.
      Limiting cache size, setting appropriate max-age, and enforcing
      cache-control headers mitigates these risks.
    remediation: >
      Configure cache with security controls. Example:
      cache my_cache total-max-size 64 max-age 3600
      Ensure sensitive responses include appropriate Cache-Control headers.
    references:
      nist:
        - SC-8
        - SI-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: backend.check_cache_security

  # ---------------------------------------------------------------------------
  # HAPR-FRT: Frontend Security
  # ---------------------------------------------------------------------------

  - id: HAPR-FRT-001
    title: Connection Limits on Frontends
    category: frontend
    tier: level1
    severity: medium
    weight: 4
    description: >
      Verify that frontend sections have connection limits configured to
      prevent resource exhaustion from excessive concurrent connections.
    rationale: >
      Without frontend connection limits, an attacker can open thousands of
      connections to exhaust HAProxy resources and prevent legitimate users
      from connecting. Limits bound the maximum resource consumption per
      frontend.
    remediation: >
      Set maxconn in each frontend section. Example:
      frontend web
        bind *:443 ssl crt /etc/ssl/cert.pem
        maxconn 10000
    references:
      nist:
        - SC-5
        - SC-6
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: frontend.check_frontend_connection_limits

  - id: HAPR-FRT-003
    title: HTTP to HTTPS Redirect
    category: frontend
    tier: level1
    severity: high
    weight: 7
    requires_mode: http
    description: >
      Verify that HTTP frontends redirect to HTTPS to ensure all traffic
      is encrypted in transit.
    rationale: >
      Serving content over plain HTTP exposes all data to network
      interception. Redirecting HTTP to HTTPS ensures encryption is applied
      to every connection, protecting credentials, session tokens, and
      sensitive data from eavesdropping.
    remediation: >
      Configure an HTTP frontend that redirects to HTTPS. Example:
      frontend http-redirect
        bind *:80
        http-request redirect scheme https unless { ssl_fc }
    references:
      nist:
        - SC-8
        - SC-8(1)
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
        - SRG-APP-000015-WSR-000014
    check_function: frontend.check_http_to_https_redirect

  - id: HAPR-FRT-004
    title: WAF Integration Detected
    category: frontend
    tier: level2
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that web application firewall integration is present, such as
      SPOE-based ModSecurity or similar WAF engine integration.
    rationale: >
      HAProxy alone provides basic traffic filtering but lacks deep packet
      inspection capabilities. WAF integration enables detection and blocking
      of complex attack payloads including SQL injection, cross-site
      scripting, and other OWASP Top 10 attacks.
    remediation: >
      Integrate a WAF engine using HAProxy SPOE (Stream Processing Offload
      Engine). Example:
      filter spoe engine modsecurity config /etc/haproxy/spoe-modsecurity.conf
    references:
      nist:
        - SI-3
        - SI-4
      owasp:
        - A03:2021 Injection
      stig:
        - SRG-APP-000141-WSR-000076
    check_function: frontend.check_waf_integration

  - id: HAPR-FRT-005
    title: SQL Injection Protection Rules
    category: frontend
    tier: level3
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that ACL rules or WAF integration provides protection against
      SQL injection patterns in request parameters and URLs.
    rationale: >
      SQL injection remains one of the most common and dangerous web
      application attacks. While backend applications should use parameterized
      queries, proxy-level filtering provides defense in depth by blocking
      common injection patterns before they reach the application.
    remediation: >
      Add ACL rules to detect and block common SQL injection patterns.
      Example:
      acl sqli_detect url_sub -i select union insert drop update delete
      acl sqli_param url_sub -i ' OR 1=1 ' -- ;--
      http-request deny if sqli_detect OR sqli_param
    references:
      nist:
        - SI-10
        - SI-3
      owasp:
        - A03:2021 Injection
      stig:
        - SRG-APP-000251-WSR-000157
    check_function: frontend.check_sql_injection_protection

  - id: HAPR-FRT-006
    title: XSS Protection Rules
    category: frontend
    tier: level3
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that ACL rules or WAF integration provides protection against
      cross-site scripting patterns in request data.
    rationale: >
      Cross-site scripting allows attackers to inject malicious scripts into
      web pages viewed by other users. Proxy-level filtering provides an
      additional layer of defense by blocking common XSS patterns such as
      script tags and event handlers before they reach the application.
    remediation: >
      Add ACL rules to detect and block common XSS patterns. Example:
      acl xss_detect url_sub -i <script javascript: onerror onload
      http-request deny if xss_detect
    references:
      nist:
        - SI-10
        - SI-3
      owasp:
        - A03:2021 Injection
        - A07:2021 Cross-Site Scripting
      stig:
        - SRG-APP-000251-WSR-000157
    check_function: frontend.check_xss_protection

  - id: HAPR-FRT-007
    title: X-Forwarded-For Configuration
    category: frontend
    tier: level1
    severity: medium
    weight: 4
    requires_mode: http
    description: >
      Verify that option forwardfor is configured to pass the real client
      IP address to backend servers via the X-Forwarded-For header.
    rationale: >
      Without option forwardfor, backend servers see HAProxy's IP as the
      client address, making it impossible to implement IP-based access
      control, rate limiting, geo-blocking, or accurate audit logging at
      the application level.
    remediation: >
      Add option forwardfor to frontends or defaults. Example:
      option forwardfor
    references:
      nist:
        - AU-3
        - AC-3
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000095-WSR-000056
    check_function: frontend.check_xff_configured

  - id: HAPR-FRT-008
    title: Bind Address Restrictions
    category: frontend
    tier: level1
    severity: medium
    weight: 4
    description: >
      Verify that frontend bind directives use specific IP addresses rather
      than wildcard addresses (0.0.0.0, *, ::) to limit network exposure.
    rationale: >
      Binding to wildcard addresses exposes HAProxy on all network interfaces
      including management, backend, and potentially untrusted networks.
      Binding to specific addresses ensures the service is only accessible
      on intended interfaces, reducing the attack surface.
    remediation: >
      Bind to specific IP addresses instead of wildcards. Example:
      bind 10.0.0.1:443 ssl crt /etc/ssl/cert.pem
    references:
      nist:
        - SC-7
        - CM-7
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000141-WSR-000076
    check_function: frontend.check_bind_address_restrictions

  - id: HAPR-SPOE-001
    title: SPOE WAF Filter Declared
    category: frontend
    tier: level2
    severity: medium
    weight: 4
    description: >
      Verify that a Stream Processing Offload Engine (SPOE) WAF filter
      is declared in frontend sections for web application firewall
      integration.
    rationale: >
      SPOE allows HAProxy to offload request inspection to external
      agents like ModSecurity or CRS for deep packet inspection. This
      provides WAF capabilities at the proxy level, required by PCI DSS
      4.0 Requirement 6.4.2 for public-facing web applications.
    remediation: >
      Configure SPOE WAF filter in frontends. Example:
      filter spoe engine modsecurity config /etc/haproxy/spoe-modsecurity.conf
    references:
      nist:
        - SI-3
        - SI-4
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000251-WSR-000157
    check_function: frontend.check_spoe_waf_filter

  - id: HAPR-SPOE-002
    title: SPOE Agent Timeout Configuration
    category: frontend
    tier: level2
    severity: low
    weight: 2
    description: >
      Verify that SPOE agent timeout values are configured to prevent
      request stalling when the offload agent is unresponsive.
    rationale: >
      Without timeouts, a slow or unresponsive SPOE agent can cause
      requests to hang indefinitely. Configuring processing and hello
      timeouts ensures graceful degradation when the WAF agent is
      unavailable.
    remediation: >
      Configure SPOE agent timeouts. Ensure the SPOE configuration
      includes timeout hello and timeout processing directives.
    references:
      nist:
        - SC-5
        - SC-10
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: frontend.check_spoe_agent_timeout

  - id: HAPR-COMP-001
    title: Compression BREACH Risk Assessment
    category: frontend
    tier: level2
    severity: medium
    weight: 4
    description: >
      Verify that HTTP compression on TLS-enabled frontends does not
      expose the configuration to BREACH attacks (CVE-2013-3587).
    rationale: >
      BREACH exploits HTTP compression on TLS connections to extract
      secrets from responses. When compression is enabled on SSL
      frontends, an attacker can progressively guess secret values
      in compressed responses by observing response size changes.
    remediation: >
      Either disable compression on SSL-enabled frontends, or ensure
      compression is only used on non-sensitive content. Consider
      using per-response compression controls to exclude sensitive pages.
    references:
      nist:
        - SC-8(1)
        - SC-13
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
    check_function: frontend.check_compression_breach_risk

  - id: HAPR-PROXY-001
    title: PROXY Protocol Source Restricted
    category: frontend
    tier: level2
    severity: high
    weight: 7
    description: >
      Verify that PROXY protocol listeners restrict accepted sources
      to trusted upstream proxies to prevent IP spoofing.
    rationale: >
      The PROXY protocol allows upstream proxies to communicate the
      original client IP. If accept-proxy is enabled without source
      restrictions, any client can forge the PROXY protocol header and
      spoof their IP address, bypassing IP-based access controls.
    remediation: >
      Restrict PROXY protocol listeners to trusted source IPs using ACLs.
      Example:
      acl trusted_proxy src 10.0.0.0/8
      http-request deny unless trusted_proxy
    references:
      nist:
        - AC-3
        - SC-7
      owasp:
        - A01:2021 Broken Access Control
      stig:
        - SRG-APP-000315-WSR-000004
    check_function: frontend.check_proxy_protocol_restricted

  # ---------------------------------------------------------------------------
  # HAPR-GBL: Global & Defaults
  # ---------------------------------------------------------------------------

  - id: HAPR-GBL-001
    title: Secure Defaults Section Exists
    category: global_defaults
    tier: baseline
    severity: high
    weight: 7
    description: >
      Verify that a defaults section exists and contains baseline security
      settings including timeouts, logging, and connection options.
    rationale: >
      The defaults section provides a security baseline that all frontends
      and backends inherit. Without a properly configured defaults section,
      each section must independently specify every setting, increasing the
      risk of accidental omissions.
    remediation: >
      Create a defaults section with essential security settings. Example:
      defaults
        mode http
        log global
        option httplog
        option dontlognull
        timeout connect 5s
        timeout client 30s
        timeout server 30s
    references:
      nist:
        - CM-6
        - CM-2
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: global_defaults.check_secure_defaults

  - id: HAPR-GBL-002
    title: Stats Socket Permissions Restricted
    category: global_defaults
    tier: level1
    severity: high
    weight: 7
    description: >
      Verify that the HAProxy stats socket has restrictive file permissions
      and is not world-accessible.
    rationale: >
      The stats socket provides full administrative control over HAProxy,
      including the ability to disable servers, change weights, and view
      sensitive metrics. World-readable or world-writable permissions allow
      any local user to manipulate the proxy configuration.
    remediation: >
      Set restrictive permissions on the stats socket. Example:
      stats socket /var/run/haproxy/admin.sock mode 660 level admin user haproxy group haproxy
    references:
      nist:
        - AC-3
        - AC-6
        - CM-6
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000141-WSR-000076
        - SRG-APP-000315-WSR-000004
    check_function: global_defaults.check_stats_socket_permissions

  - id: HAPR-GBL-003
    title: DNS Resolver Configured
    category: global_defaults
    tier: level2
    severity: low
    weight: 2
    description: >
      Verify that a DNS resolver section is configured for backends using
      DNS-based server discovery, ensuring DNS resolution is controlled.
    rationale: >
      Using system DNS resolution without explicit configuration may rely on
      insecure or unreliable resolvers. A dedicated resolver section allows
      specifying trusted DNS servers, controlling TTL behavior, and ensuring
      HAProxy can resolve backend addresses even during DNS disruptions.
    remediation: >
      Configure a resolvers section with trusted DNS servers. Example:
      resolvers mydns
        nameserver dns1 10.0.0.2:53
        nameserver dns2 10.0.0.3:53
        resolve_retries 3
        timeout resolve 1s
        timeout retry 1s
        hold valid 10s
    references:
      nist:
        - SC-20
        - SC-22
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: global_defaults.check_dns_resolver

  - id: HAPR-GBL-004
    title: Global Maxconn Set
    category: global_defaults
    tier: baseline
    severity: medium
    weight: 4
    description: >
      Verify that the global maxconn value is explicitly set to limit the
      total number of concurrent connections HAProxy will accept.
    rationale: >
      Without a global maxconn, HAProxy may accept more connections than
      system resources can support, leading to memory exhaustion and process
      instability. An explicit limit ensures predictable resource consumption
      and prevents system-wide impact from traffic surges.
    remediation: >
      Set maxconn in the global section based on available system resources.
      Example:
      global
        maxconn 50000
    references:
      nist:
        - SC-5
        - SC-6
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: global_defaults.check_global_maxconn

  - id: HAPR-GBL-006
    title: Hard-Stop-After Configured
    category: global_defaults
    tier: level1
    severity: low
    weight: 2
    description: >
      Verify that hard-stop-after is configured in the global section to
      set a maximum time for graceful shutdown during reloads.
    rationale: >
      Without hard-stop-after, HAProxy may wait indefinitely for active
      connections to close during a reload or shutdown, preventing new
      configuration from taking effect. This can leave stale processes
      running and consuming resources, and delay security updates.
    remediation: >
      Add hard-stop-after to the global section. Example:
      hard-stop-after 30s
    references:
      nist:
        - CM-6
        - SC-5
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: global_defaults.check_hard_stop_after

  - id: HAPR-GBL-007
    title: Nbproc Not Used (Deprecated)
    category: global_defaults
    tier: level1
    severity: medium
    weight: 4
    description: >
      Verify that the deprecated nbproc directive is not used. HAProxy 2.5+
      deprecates nbproc in favor of nbthread for multi-processing.
    rationale: >
      The nbproc directive spawns multiple HAProxy processes which do not
      share state (stick tables, counters, health check results). This
      breaks rate limiting, session persistence, and coordinated health
      checks. The nbthread directive provides multi-core scaling while
      maintaining shared state within a single process.
    remediation: >
      Remove nbproc from the global section and use nbthread instead.
      Example: nbthread 4
    references:
      nist:
        - CM-6
        - CM-2
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000516-WSR-000174
    check_function: global_defaults.check_nbproc_not_used

  - id: HAPR-LUA-001
    title: Lua Memory Limit Set
    category: global_defaults
    tier: level2
    severity: medium
    weight: 4
    description: >
      Verify that Lua script memory limits are configured when Lua
      scripts are loaded in the HAProxy configuration.
    rationale: >
      Lua scripts executing without memory limits can consume unbounded
      memory, leading to out-of-memory conditions and service disruption.
      Setting tune.lua.maxmem prevents a single Lua context from
      exhausting system resources.
    remediation: >
      Set tune.lua.maxmem in the global section to limit Lua memory.
      Example: tune.lua.maxmem 0 (unlimited, default) or
      tune.lua.maxmem 64 (64 MB limit)
    references:
      nist:
        - SC-5
        - SC-6
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: global_defaults.check_lua_memory_limit

  - id: HAPR-LUA-002
    title: Lua Forced Yield Configured
    category: global_defaults
    tier: level2
    severity: low
    weight: 2
    description: >
      Verify that Lua forced yield is configured to prevent Lua scripts
      from monopolizing CPU time in HAProxy's event loop.
    rationale: >
      Without forced yield, a long-running Lua script can block the
      event loop and cause all connections to stall. The tune.lua.forced-yield
      parameter forces Lua to yield after a specified number of instructions,
      maintaining responsiveness.
    remediation: >
      Set tune.lua.forced-yield in the global section.
      Example: tune.lua.forced-yield 10000
    references:
      nist:
        - SC-5
        - SC-6
      owasp:
        - A05:2021 Security Misconfiguration
      stig:
        - SRG-APP-000246-WSR-000149
    check_function: global_defaults.check_lua_forced_yield

  - id: HAPR-PEER-001
    title: Peer Communication Encrypted
    category: global_defaults
    tier: level2
    severity: medium
    weight: 4
    description: >
      Verify that HAProxy peer communication (stick-table replication)
      uses encrypted connections between nodes.
    rationale: >
      HAProxy peers sections replicate stick-table data between cluster
      nodes. Without encryption, this replication traffic exposes session
      data, rate limiting counters, and health information to network
      eavesdroppers.
    remediation: >
      Configure SSL for peer communication by adding ssl, crt, and ca-file
      directives to the peers section server lines.
    references:
      nist:
        - SC-8
        - SC-8(1)
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
    check_function: global_defaults.check_peer_encryption

  # ---------------------------------------------------------------------------
  # HAPR-SCAN: Live TLS Scan
  # ---------------------------------------------------------------------------

  - id: HAPR-SCAN-001
    title: No Deprecated TLS Versions Accepted
    category: tls_live
    tier: level2
    severity: critical
    weight: 10
    description: >
      Perform a live scan to verify that the HAProxy endpoint does not
      accept connections using deprecated TLS versions (SSLv2, SSLv3,
      TLS 1.0, TLS 1.1).
    rationale: >
      Configuration analysis alone cannot guarantee runtime behavior, as
      OpenSSL compilation flags or library versions may override config
      settings. A live scan confirms that deprecated protocol versions are
      actually rejected by the running service.
    remediation: >
      If deprecated versions are accepted despite configuration, verify the
      OpenSSL version supports the configured restrictions and rebuild if
      necessary. Check for bind-line overrides that may re-enable old
      protocols.
    references:
      nist:
        - SC-8
        - SC-8(1)
        - SC-13
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
        - SRG-APP-000442-WSR-000064
    check_function: tls_live.check_deprecated_protocols_live
    requires: scanner

  - id: HAPR-SCAN-002
    title: No Weak Ciphers Negotiated
    category: tls_live
    tier: level2
    severity: critical
    weight: 10
    description: >
      Perform a live scan to verify that the HAProxy endpoint does not
      negotiate weak cipher suites including NULL, EXPORT, DES, RC4,
      and anonymous ciphers.
    rationale: >
      Live cipher scanning validates that the running configuration actually
      rejects weak ciphers. Misconfigured cipher strings, OpenSSL defaults,
      or compilation options may allow weak ciphers even when the
      configuration appears correct.
    remediation: >
      If weak ciphers are negotiated, review the effective cipher list using
      openssl ciphers and adjust ssl-default-bind-ciphers. Ensure no
      individual bind lines override the global cipher settings.
    references:
      nist:
        - SC-8(1)
        - SC-13
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
        - SRG-APP-000179-WSR-000110
    check_function: tls_live.check_weak_ciphers_live
    requires: scanner

  - id: HAPR-SCAN-003
    title: Valid Certificate Chain
    category: tls_live
    tier: level2
    severity: high
    weight: 7
    description: >
      Perform a live scan to verify that the server presents a valid
      certificate chain from a trusted certificate authority, with no
      missing intermediate certificates.
    rationale: >
      An incomplete or invalid certificate chain causes TLS warnings or
      failures in clients, pushing users to bypass security warnings. Missing
      intermediate certificates are a common misconfiguration that breaks
      chain validation for strict clients.
    remediation: >
      Ensure the certificate file includes the full chain in order: server
      certificate, intermediate certificates, and optionally the root CA.
      Use openssl s_client -connect host:port to verify the chain.
    references:
      nist:
        - SC-8
        - IA-5(2)
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000427-WSR-000186
    check_function: tls_live.check_certificate_chain
    requires: scanner

  - id: HAPR-SCAN-004
    title: Certificate Not Expired
    category: tls_live
    tier: level3
    severity: critical
    weight: 10
    description: >
      Perform a live scan to verify that the server certificate is currently
      valid and has not expired or is not yet valid.
    rationale: >
      An expired certificate causes immediate TLS failures or browser
      warnings, degrading security posture and user trust. Certificate
      expiration is a top cause of service disruptions and may indicate
      neglected security maintenance processes.
    remediation: >
      Renew the certificate before expiration. Implement automated
      certificate renewal using ACME/Let's Encrypt or your CA's renewal
      process. Set up monitoring alerts for certificates expiring within 30
      days.
    references:
      nist:
        - SC-8
        - SC-17
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000427-WSR-000186
    check_function: tls_live.check_certificate_expiry
    requires: scanner

  - id: HAPR-SCAN-005
    title: No Known TLS Vulnerabilities
    category: tls_live
    tier: level3
    severity: critical
    weight: 10
    description: >
      Perform a live scan to check for known TLS implementation
      vulnerabilities including Heartbleed (CVE-2014-0160), ROBOT attack,
      and CCS Injection (CVE-2014-0224).
    rationale: >
      These vulnerabilities allow attackers to extract private keys
      (Heartbleed), decrypt TLS traffic (ROBOT), or perform man-in-the-middle
      attacks (CCS Injection). They exist at the implementation level and
      cannot be detected through configuration analysis alone.
    remediation: >
      Update OpenSSL to the latest patched version. Heartbleed requires
      OpenSSL 1.0.1g or later. CCS Injection requires OpenSSL 0.9.8za,
      1.0.0m, or 1.0.1h or later. After patching, regenerate all private
      keys and certificates.
    references:
      nist:
        - SC-8
        - SI-2
        - RA-5
      owasp:
        - A06:2021 Vulnerable and Outdated Components
      stig:
        - SRG-APP-000439-WSR-000156
        - SRG-APP-000454-WSR-000170
    check_function: tls_live.check_tls_vulnerabilities
    requires: scanner

  - id: HAPR-SCAN-006
    title: Secure Renegotiation Supported
    category: tls_live
    tier: level2
    severity: medium
    weight: 4
    description: >
      Perform a live scan to verify that the server supports secure TLS
      renegotiation (RFC 5746) and does not allow insecure client-initiated
      renegotiation.
    rationale: >
      Insecure renegotiation allows attackers to inject plaintext into a TLS
      connection, leading to request smuggling or data injection. Client-
      initiated renegotiation can also be used for denial-of-service attacks
      by forcing expensive cryptographic operations.
    remediation: >
      Ensure OpenSSL is compiled with secure renegotiation support (standard
      in modern versions). Disable client-initiated renegotiation by updating
      to HAProxy 1.8+ which disables it by default, or use
      ssl-default-bind-options no-tls-tickets.
    references:
      nist:
        - SC-8
        - SC-13
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000439-WSR-000156
    check_function: tls_live.check_secure_renegotiation_live
    requires: scanner

  - id: HAPR-SCAN-007
    title: Certificate Key Size Adequate
    category: tls_live
    tier: level2
    severity: medium
    weight: 4
    description: >
      Verify that certificate key sizes meet minimum requirements:
      RSA >= 2048 bits, ECDSA >= 256 bits via live TLS scanning.
    rationale: >
      Certificates with inadequate key sizes are vulnerable to
      brute-force attacks. NIST SP 800-52 Rev. 2 requires RSA keys
      of at least 2048 bits and ECDSA keys of at least 256 bits for
      adequate security through 2030.
    remediation: >
      Generate certificates with adequate key sizes. For RSA, use at
      least 2048 bits (4096 preferred). For ECDSA, use P-256 or P-384 curves.
    references:
      nist:
        - SC-12
        - SC-13
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000179-WSR-000110
    check_function: tls_live.check_certificate_key_size
    requires: scanner

  - id: HAPR-SCAN-008
    title: Certificate Expiry Warning
    category: tls_live
    tier: level2
    severity: medium
    weight: 4
    description: >
      Warn if any certificate will expire within 30 days via live TLS
      scanning, providing early notice for certificate renewal.
    rationale: >
      Certificate expiry causes service outages and security warnings
      for users. A 30-day warning window provides adequate time for
      certificate renewal, even accounting for procurement and approval
      processes in enterprise environments.
    remediation: >
      Renew certificates before they expire. Implement automated
      certificate management (e.g., ACME/Let's Encrypt) to prevent
      expiry-related outages.
    references:
      nist:
        - SC-12
        - SC-17
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000175-WSR-000095
    check_function: tls_live.check_certificate_expiry_warning
    requires: scanner

  - id: HAPR-SCAN-009
    title: Certificate Hostname Match
    category: tls_live
    tier: level2
    severity: high
    weight: 7
    description: >
      Verify that certificate subject or SAN entries match the target
      hostname via live TLS scanning.
    rationale: >
      A certificate that does not match the hostname causes browser
      trust warnings and may indicate a misconfigured or compromised
      server. RFC 6125 requires hostname validation via SAN entries
      (preferred) or the CN in the subject.
    remediation: >
      Ensure certificates are issued with correct Subject Alternative
      Names (SANs) matching all hostnames served. Use wildcard
      certificates for subdomains where appropriate.
    references:
      nist:
        - SC-8(1)
        - IA-5(2)
      owasp:
        - A02:2021 Cryptographic Failures
      stig:
        - SRG-APP-000427-WSR-000186
    check_function: tls_live.check_certificate_hostname_match
    requires: scanner

  # ---------------------------------------------------------------------------
  # HAPR-CVE: Known Vulnerabilities
  # ---------------------------------------------------------------------------

  - id: HAPR-CVE-001
    title: No Critical CVEs for Detected Version
    category: cve
    tier: baseline
    severity: critical
    weight: 10
    description: >
      Check the detected HAProxy version against a database of known
      critical CVEs to identify unpatched vulnerabilities with CVSS scores
      of 9.0 or higher.
    rationale: >
      Critical CVEs represent vulnerabilities that can be exploited remotely
      with minimal complexity, often leading to complete system compromise.
      Running a version with known critical vulnerabilities puts the entire
      infrastructure at immediate risk.
    remediation: >
      Upgrade HAProxy to the latest stable release that patches all known
      critical CVEs. Review the HAProxy security advisories at
      https://www.haproxy.org/bugs.html and plan immediate remediation.
    references:
      nist:
        - SI-2
        - SI-2(2)
        - RA-5
      owasp:
        - A06:2021 Vulnerable and Outdated Components
      stig:
        - SRG-APP-000456-WSR-000187
        - SRG-APP-000454-WSR-000170
    check_function: cve.check_critical_cves
    requires: version

  - id: HAPR-CVE-002
    title: No High Severity CVEs for Detected Version
    category: cve
    tier: level3
    severity: high
    weight: 7
    description: >
      Check the detected HAProxy version against a database of known high
      severity CVEs to identify unpatched vulnerabilities with CVSS scores
      between 7.0 and 8.9.
    rationale: >
      High severity CVEs can lead to significant security impact including
      remote code execution, privilege escalation, or data exposure. While
      they may require more specific conditions than critical CVEs, they
      still represent serious risk to the deployment.
    remediation: >
      Plan an upgrade to the latest stable HAProxy release within your
      maintenance window. Review each CVE to determine if temporary
      mitigations (such as configuration changes) can reduce risk until the
      upgrade is completed.
    references:
      nist:
        - SI-2
        - RA-5
      owasp:
        - A06:2021 Vulnerable and Outdated Components
      stig:
        - SRG-APP-000456-WSR-000187
    check_function: cve.check_high_cves
    requires: version

  - id: HAPR-CVE-003
    title: HTTP Request Smuggling CVE-2021-40346
    category: cve
    tier: level3
    severity: critical
    weight: 10
    description: >
      Check specifically for CVE-2021-40346, an integer overflow
      vulnerability in HAProxy's HTTP request parsing that allows HTTP
      request smuggling. Affects HAProxy versions before 2.0.25, 2.2.x
      before 2.2.17, 2.3.x before 2.3.14, and 2.4.x before 2.4.4.
    rationale: >
      CVE-2021-40346 allows an attacker to smuggle HTTP requests past
      HAProxy's parsing logic using a specially crafted Content-Length header
      with a specific integer overflow. This bypasses ACLs, WAF rules, and
      authentication checks, enabling direct access to backend systems.
      It is particularly dangerous because it undermines all proxy-level
      security controls.
    remediation: >
      Upgrade HAProxy to version 2.0.25, 2.2.17, 2.3.14, 2.4.4, or later
      to patch this vulnerability. As a temporary mitigation, add a rule to
      reject requests with multiple Content-Length headers:
      http-request deny if { req.hdr_cnt(content-length) gt 1 }
    references:
      nist:
        - SI-2
        - SI-10
        - RA-5
      owasp:
        - A06:2021 Vulnerable and Outdated Components
        - A03:2021 Injection
      stig:
        - SRG-APP-000454-WSR-000170
        - SRG-APP-000456-WSR-000187
    check_function: cve.check_request_smuggling_cve
    requires: version
