# Docker Compose for HAPR testing environment
# Starts HAProxy with TLS + a simple echo backend

services:
  # -----------------------------------------------------------------------
  # Echo backend server
  # Simple Python HTTP server that returns request details as JSON
  # -----------------------------------------------------------------------
  echo:
    image: python:3.12-slim
    container_name: hapr-echo
    working_dir: /app
    command: python echo-server.py
    volumes:
      - ./echo-server.py:/app/echo-server.py:ro
    expose:
      - "8080"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/')"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 3s
    restart: unless-stopped

  # -----------------------------------------------------------------------
  # HAProxy - main load balancer / reverse proxy
  # Exposes:
  #   8080  - HTTP (redirects to HTTPS)
  #   8443  - HTTPS (TLS termination)
  #   8404  - Stats dashboard
  # -----------------------------------------------------------------------
  haproxy:
    image: haproxy:2.9-alpine
    container_name: hapr-haproxy
    volumes:
      - ./live-server.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
      - ./haproxy-test.pem:/etc/haproxy/certs/haproxy-test.pem:ro
    ports:
      - "8080:8080"
      - "8443:8443"
      - "8404:8404"
    depends_on:
      echo:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "haproxy", "-c", "-f", "/usr/local/etc/haproxy/haproxy.cfg"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped
