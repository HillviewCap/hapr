# =============================================================================
# HAProxy Test Configuration for HAPR Audit Tool
# 
# This config is intentionally a MIX of good and bad security practices
# so that the HAPR audit tool can demonstrate both PASS and FAIL findings.
# =============================================================================

# ---------------------------------------------------------------------------
# GLOBAL SECTION
# ---------------------------------------------------------------------------
global
    # Logging to stdout for Docker visibility
    log stdout format raw local0 info

    # Stats socket for runtime API (GOOD: enables monitoring)
    # Using /tmp since /var/run may not be writable in container
    stats socket /tmp/haproxy.sock mode 660 level admin

    # Process management
    maxconn 4096

    # --- INTENTIONAL WEAKNESS: Allow old TLS versions ---
    # HAPR should flag this as insecure (TLSv1.0 and TLSv1.1 are deprecated)
    ssl-default-bind-options ssl-min-ver TLSv1.0
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256

    # --- INTENTIONAL WEAKNESS: Include weak ciphers ---
    # DES-CBC3-SHA and RC4 are considered weak/broken
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA:DES-CBC3-SHA:RC4-SHA

    # Tuning
    tune.ssl.default-dh-param 2048

# ---------------------------------------------------------------------------
# DEFAULTS SECTION
# ---------------------------------------------------------------------------
defaults
    # GOOD: Use HTTP mode with logging
    mode http
    log global
    option httplog

    # GOOD: Forward client IP
    option forwardfor except 127.0.0.0/8

    # GOOD: Enable HTTP connection closing
    option http-server-close

    # Timeouts (reasonable production values)
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    timeout http-request 10s
    timeout http-keep-alive 10s
    timeout queue 30s

    # --- INTENTIONAL WEAKNESS: No default rate limiting ---
    # No stick-table or rate-limiting defined in defaults

    # Retries
    retries 3
    option redispatch

    # Error files (standard)
    errorfile 400 /usr/local/etc/haproxy/errors/400.http
    errorfile 403 /usr/local/etc/haproxy/errors/403.http
    errorfile 408 /usr/local/etc/haproxy/errors/408.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http
    errorfile 502 /usr/local/etc/haproxy/errors/502.http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 504 /usr/local/etc/haproxy/errors/504.http

# ---------------------------------------------------------------------------
# STATS FRONTEND - Port 8404
# Provides the HAProxy stats dashboard
# ---------------------------------------------------------------------------
frontend ft_stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    # --- INTENTIONAL WEAKNESS: Stats page has no authentication ---
    # stats auth admin:password   # <-- commented out on purpose
    # --- INTENTIONAL WEAKNESS: Stats admin enabled without auth ---
    stats admin if TRUE

# ---------------------------------------------------------------------------
# HTTPS FRONTEND - Port 8443 (TLS termination)
# This is the main production entry point
# ---------------------------------------------------------------------------
frontend ft_https
    bind *:8443 ssl crt /etc/haproxy/certs/haproxy-test.pem

    mode http

    # --- GOOD: HSTS header (Strict-Transport-Security) ---
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # --- GOOD: X-Frame-Options to prevent clickjacking ---
    http-response set-header X-Frame-Options "DENY"

    # --- GOOD: X-Content-Type-Options ---
    http-response set-header X-Content-Type-Options "nosniff"

    # --- INTENTIONAL WEAKNESS: No Content-Security-Policy header ---
    # --- INTENTIONAL WEAKNESS: No X-XSS-Protection header ---
    # --- INTENTIONAL WEAKNESS: No Referrer-Policy header ---

    # --- GOOD: Remove server version disclosure ---
    http-response del-header Server

    # ACLs for routing
    acl is_api path_beg /api
    acl is_health path /health
    acl is_static path_beg /static /images /css /js

    # --- INTENTIONAL WEAKNESS: No request size limit ---
    # (no tune.maxrewrite, no req.body_size check)

    # Health check endpoint - respond directly
    http-request return status 200 content-type text/plain string "OK" if is_health

    # Route all traffic to backend
    default_backend bk_app

# ---------------------------------------------------------------------------
# HTTP FRONTEND - Port 8080 (plain HTTP with redirect)
# ---------------------------------------------------------------------------
frontend ft_http
    bind *:8080
    mode http

    # --- GOOD: Redirect HTTP to HTTPS ---
    http-request redirect scheme https code 301 unless { ssl_fc }

    # --- INTENTIONAL WEAKNESS: No security headers on HTTP frontend ---
    # (headers only applied on ft_https, not here before redirect)

    # --- INTENTIONAL WEAKNESS: No rate limiting on HTTP frontend ---

    default_backend bk_app

# ---------------------------------------------------------------------------
# APPLICATION BACKEND
# Routes to the echo/backend service
# ---------------------------------------------------------------------------
backend bk_app
    mode http
    balance roundrobin

    # --- GOOD: Health checking ---
    option httpchk GET /
    http-check expect status 200

    # --- INTENTIONAL WEAKNESS: No inter/fastinter/downinter tuning ---
    # --- INTENTIONAL WEAKNESS: No cookie-based persistence with httponly/secure ---

    # --- GOOD: Add X-Forwarded headers ---
    http-request set-header X-Forwarded-Port %[dst_port]
    http-request set-header X-Forwarded-Proto https if { ssl_fc }

    # Backend server - points to the echo service container
    # --- INTENTIONAL WEAKNESS: Backend connection is plain HTTP (no ssl verify) ---
    server app1 echo:8080 check inter 5s fall 3 rise 2
