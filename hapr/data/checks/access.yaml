# HAPR-ACL: Access Control
- id: HAPR-ACL-001
  title: ACLs Defined in Frontends
  category: access
  tier: level1
  severity: medium
  weight: 4
  description: >
    Verify that frontend sections define access control lists (ACLs) to filter and
    route traffic based on request attributes.
  rationale: >
    ACLs are the primary mechanism in HAProxy for implementing access control policies.
    Frontends without ACLs pass all traffic to backends without any filtering, increasing
    exposure to malicious requests.
  remediation: >
    Define ACL rules in each frontend to filter traffic by source IP, path, headers,
    or other criteria. Example: acl internal_net src 10.0.0.0/8 192.168.0.0/16
  references:
    nist:
    - AC-3
    - AC-4
    owasp:
    - A01:2021 Broken Access Control
    stig:
    - SRG-APP-000315-WSR-000004
  check_function: access.check_acls_defined
- id: HAPR-ACL-002
  title: Admin Paths Restricted
  category: access
  tier: level2
  severity: high
  weight: 7
  requires_mode: http
  description: >
    Verify that administrative paths such as /admin, /manager, and /haproxy?stats
    are restricted by IP address or authentication.
  rationale: >
    Administrative endpoints exposed without access restrictions allow attackers to
    manage or reconfigure the proxy, view sensitive operational data, or pivot to
    backend systems.
  remediation: >
    Use ACLs to restrict admin paths to trusted source IPs or require HTTP basic authentication.
    Example: acl admin_path path_beg /admin /manager acl trusted_src src 10.0.0.0/8
    http-request deny if admin_path !trusted_src
  references:
    nist:
    - AC-3
    - AC-6
    - AC-6(1)
    owasp:
    - A01:2021 Broken Access Control
    stig:
    - SRG-APP-000315-WSR-000004
    - SRG-APP-000141-WSR-000076
  check_function: access.check_admin_path_restricted
- id: HAPR-ACL-003
  title: Rate Limiting Configured
  category: access
  tier: level1
  severity: high
  weight: 7
  description: >
    Verify that rate limiting is implemented using stick tables, ACLs, or external
    mechanisms to throttle excessive requests.
  rationale: >
    Without rate limiting, HAProxy is vulnerable to brute-force attacks, credential
    stuffing, and application-layer denial of service. Rate limiting is essential
    for protecting backend resources from abuse.
  remediation: >
    Implement rate limiting using stick tables with http_req_rate or conn_rate tracking.
    Example: stick-table type ip size 100k expire 30s store http_req_rate(10s) http-request
    deny deny_status 429 if { sc_http_req_rate(0) gt 100 }
  references:
    nist:
    - SC-5
    - SI-10
    owasp:
    - A05:2021 Security Misconfiguration
    stig:
    - SRG-APP-000246-WSR-000149
  check_function: access.check_rate_limiting
- id: HAPR-ACL-004
  title: Stick Tables for Connection Tracking
  category: access
  tier: level1
  severity: medium
  weight: 4
  description: >
    Verify that stick tables are configured for connection and request tracking to
    enable abuse detection and rate limiting.
  rationale: >
    Stick tables maintain per-client state that enables HAProxy to detect anomalous
    traffic patterns, enforce rate limits, and support session persistence. Without
    them, abuse detection relies entirely on external systems.
  remediation: >
    Configure stick tables in relevant backends or frontends to track connection rates,
    request rates, or byte counters. Example: stick-table type ip size 200k expire
    5m store conn_cur,conn_rate(3s),http_req_rate(10s)
  references:
    nist:
    - SC-5
    - AU-6
    owasp:
    - A05:2021 Security Misconfiguration
    stig:
    - SRG-APP-000246-WSR-000149
  check_function: access.check_stick_tables
- id: HAPR-ACL-005
  title: Stats Access Fully Restricted
  category: access
  tier: level1
  severity: high
  weight: 7
  description: >
    Verify that the HAProxy stats page, if enabled, is protected with authentication
    and/or IP-based access restrictions. Also checks that stats hide-version is enabled
    to prevent version disclosure and that the stats admin directive is restricted
    by ACL to prevent unauthorized administrative actions on the stats page.
  rationale: >
    The stats page exposes detailed operational information including server health,
    connection counts, error rates, and backend topology. Unrestricted access provides
    attackers with reconnaissance data for targeting backends. Exposing the HAProxy
    version on the stats page aids further reconnaissance, and an unprotected stats
    admin interface allows live manipulation of backend server states.
  remediation: >
    Restrict stats access with authentication, IP filtering, version hiding, and admin
    ACL. Example: stats auth admin:securepassword stats hide-version stats admin if
    LOCALHOST acl stats_allowed src 10.0.0.0/8 http-request deny if !stats_allowed
  references:
    nist:
    - AC-3
    - AC-6
    owasp:
    - A01:2021 Broken Access Control
    stig:
    - SRG-APP-000315-WSR-000004
  check_function: access.check_stats_access_restricted
- id: HAPR-ACL-006
  title: Userlist Passwords Hashed
  category: access
  tier: level1
  severity: high
  weight: 7
  description: >
    Verify that userlist passwords use crypt(3)-style hashing rather than the insecure-password
    directive which stores credentials in cleartext.
  rationale: >
    HAProxy userlists support two password storage methods: the password directive
    (which expects a crypt hash) and insecure-password (which stores plaintext). Cleartext
    passwords in configuration files are trivially compromised if the file is exposed
    through backups, version control, or unauthorized filesystem access.
  remediation: >
    Replace insecure-password with password and provide a crypt(3) hash. Generate
    hashes using mkpasswd. Example: mkpasswd -m sha-512 mypassword userlist myusers
      user admin password $6$rounds=5000$salt$hashedvalue
  references:
    nist:
    - IA-5
    - IA-5(1)
    owasp:
    - A02:2021 Cryptographic Failures
    stig:
    - SRG-APP-000171-WSR-000100
  check_function: access.check_userlist_passwords
- id: HAPR-ACL-007
  title: Source IP Restrictions on Admin Interfaces
  category: access
  tier: level1
  severity: high
  weight: 7
  requires_mode: http
  description: >
    Verify that source IP restrictions are configured on administrative interfaces,
    stats pages, and management endpoints to limit access to trusted networks.
  rationale: >
    Administrative interfaces exposed to all source IPs are vulnerable to brute-force
    attacks, credential stuffing, and unauthorized access. Restricting access by source
    IP provides a strong network-layer defense even if authentication is compromised.
  remediation: >
    Add source IP-based ACLs to restrict admin access. Example: acl trusted_src src
    10.0.0.0/8 192.168.0.0/16 http-request deny if !trusted_src
  references:
    nist:
    - AC-3
    - AC-6
    - SC-7
    owasp:
    - A01:2021 Broken Access Control
    stig:
    - SRG-APP-000315-WSR-000004
    - SRG-APP-000141-WSR-000076
  check_function: access.check_source_ip_restrictions
- id: HAPR-JWT-001
  title: JWT Signature Verification Enforced
  category: access
  tier: level3
  severity: high
  weight: 7
  requires_mode: http
  description: >
    Verify that JWT (JSON Web Token) signature verification is enforced at the proxy
    level for API gateway configurations.
  rationale: >
    Without JWT verification at the proxy, unsigned or tampered tokens may reach backend
    services. HAProxy 2.5+ supports native JWT verification, and Lua scripts can provide
    similar functionality in older versions.
  remediation: >
    Configure JWT verification using HAProxy's native jwt_verify functionality or
    a Lua script. Ensure all API endpoints validate the Authorization header before
    forwarding requests.
  references:
    nist:
    - IA-2
    - IA-5
    - AC-3
    owasp:
    - A07:2021 Identification and Authentication Failures
    stig:
    - SRG-APP-000219-WSR-000036
  check_function: access.check_jwt_verification
- id: HAPR-JWT-002
  title: JWT Algorithm Restriction (No alg:none)
  category: access
  tier: level3
  severity: critical
  weight: 10
  requires_mode: http
  description: >
    Verify that JWT configurations restrict allowed signing algorithms and prevent
    the alg:none attack vector.
  rationale: >
    The JWT alg:none attack allows attackers to bypass signature verification entirely
    by specifying "none" as the algorithm. Restricting algorithms to specific approved
    values (RS256, ES256, etc.) prevents this critical attack vector.
  remediation: >
    Explicitly specify allowed JWT algorithms in verification configuration. Never
    accept 'none' as a valid algorithm. Example: verify using RS256 or ES256 only.
  references:
    nist:
    - SC-13
    - IA-5
    owasp:
    - A02:2021 Cryptographic Failures
    - A07:2021 Identification and Authentication Failures
    stig:
    - SRG-APP-000179-WSR-000110
  check_function: access.check_jwt_algorithm_restriction
- id: HAPR-BOT-001
  title: Bot Detection Patterns Configured
  category: access
  tier: level3
  severity: medium
  weight: 4
  requires_mode: http
  description: >
    Verify that bot detection patterns are configured to filter automated traffic
    based on User-Agent and behavioral patterns.
  rationale: >
    Automated bots can consume resources, scrape content, and probe for vulnerabilities.
    User-Agent filtering at the proxy level provides a first line of defense against
    known malicious bots and crawlers.
  remediation: >
    Add ACL rules to filter known bad User-Agent strings. Example: acl bad_bot hdr(User-Agent)
    -i -m sub bot crawler spider http-request deny if bad_bot
  references:
    nist:
    - SC-5
    - SI-4
    owasp:
    - A05:2021 Security Misconfiguration
    stig:
    - SRG-APP-000246-WSR-000149
  check_function: access.check_bot_detection
- id: HAPR-IPREP-001
  title: IP Reputation Integration Detected
  category: access
  tier: level3
  severity: medium
  weight: 4
  description: >
    Verify that IP reputation or threat intelligence integration is configured to
    block known malicious sources.
  rationale: >
    IP reputation services (CrowdSec, fail2ban, commercial threat intelligence feeds)
    provide dynamic blocking of known malicious IP addresses, significantly reducing
    attack surface from known threat actors.
  remediation: >
    Integrate an IP reputation service such as CrowdSec bouncer or configure map-based
    IP blocklists that are periodically updated. Example: http-request deny if { src
    -f /etc/haproxy/blocklist.map }
  references:
    nist:
    - SI-4
    - SC-7(5)
    owasp:
    - A05:2021 Security Misconfiguration
    stig:
    - SRG-APP-000315-WSR-000004
  check_function: access.check_ip_reputation_integration
- id: HAPR-API-001
  title: API Authentication Enforcement
  category: access
  tier: level3
  severity: high
  weight: 7
  requires_mode: http
  description: >
    Verify that API endpoints enforce authentication by requiring valid credentials
    before processing requests.
  rationale: >
    Unauthenticated API endpoints expose backend services to abuse, data leakage,
    and unauthorized access. Enforcing authentication at the proxy level ensures no
    request reaches backends without valid credentials.
  remediation: >
    Add authentication requirements for API paths using ACLs and deny rules. Example:
    acl api_path path_beg /api /v1 /v2 acl has_auth req.hdr(Authorization) -m found
    http-request deny if api_path !has_auth
  references:
    nist:
    - IA-2
    - AC-3
    - AC-17
    owasp:
    - A07:2021 Identification and Authentication Failures
    - A01:2021 Broken Access Control
    stig:
    - SRG-APP-000219-WSR-000036
  check_function: access.check_api_authentication
- id: HAPR-API-002
  title: Per-API Rate Limiting
  category: access
  tier: level3
  severity: medium
  weight: 4
  requires_mode: http
  description: >
    Verify that API endpoints have dedicated rate limiting to prevent abuse and ensure
    fair resource allocation.
  rationale: >
    API endpoints are common targets for brute-force attacks, credential stuffing,
    and resource exhaustion. Per-API rate limiting ensures that abuse of one endpoint
    does not affect others and prevents automated attacks.
  remediation: >
    Configure stick-tables and rate limiting specific to API paths. Example: stick-table
    type ip size 100k expire 30s store http_req_rate(10s) acl api_path path_beg /api
    http-request track-sc0 src if api_path http-request deny deny_status 429 if api_path
    { sc_http_req_rate(0) gt 100 }
  references:
    nist:
    - SC-5
    - SC-5(2)
    owasp:
    - A04:2021 Insecure Design
    stig:
    - SRG-APP-000246-WSR-000149
  check_function: access.check_api_rate_limiting
