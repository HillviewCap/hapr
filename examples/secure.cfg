# =============================================================================
# Secure HAProxy Configuration
# A well-hardened configuration suitable for production security-sensitive
# environments. This config should score high on security audits.
# =============================================================================

global
    # Chroot for process isolation
    chroot /var/lib/haproxy

    # Drop privileges
    user haproxy
    group haproxy

    # Logging to rsyslog
    log /dev/log local0 info
    log /dev/log local1 notice

    # Daemon mode
    daemon

    # Max connections
    maxconn 4096

    # SSL/TLS hardening
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-bind-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256
    ssl-default-server-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-server-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256

    # DH parameter size
    tune.ssl.default-dh-param 2048

    # Stats socket with restrictive permissions
    stats socket /var/run/haproxy/admin.sock mode 0600 level admin
    stats timeout 30s

    # Spread health checks to avoid thundering herd
    spread-checks 4

# =============================================================================
# Defaults
# =============================================================================
defaults
    mode http
    log global

    # Logging options
    option httplog
    option dontlognull
    option log-health-checks

    # HTTP options
    option forwardfor except 127.0.0.0/8
    option http-server-close
    option redispatch

    # Timeouts
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    timeout http-request 10s
    timeout http-keep-alive 15s
    timeout queue 30s
    timeout check 5s
    timeout tunnel 1h
    timeout client-fin 30s
    timeout server-fin 30s

    # Connection limits
    maxconn 3000

    # Retries
    retries 3

    # Error files
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# =============================================================================
# Frontend: HTTPS (Primary)
# =============================================================================
frontend ft_https
    bind *:443 ssl crt /etc/ssl/private/webapp.pem ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256 alpn h2,http/1.1
    mode http
    maxconn 3000

    # --- Rate Limiting ---
    # Track requests per source IP
    stick-table type ip size 200k expire 5m store http_req_rate(10s),conn_cur,conn_rate(10s)
    http-request track-sc0 src

    # Deny if request rate exceeds 100 per 10 seconds
    acl is_abuse sc0_http_req_rate gt 100
    acl too_many_conns sc0_conn_rate gt 50
    http-request deny deny_status 429 if is_abuse
    http-request deny deny_status 429 if too_many_conns

    # --- ACLs for path-based routing ---
    acl is_api path_beg /api/
    acl is_static path_beg /static/ /assets/ /images/ /css/ /js/
    acl is_admin path_beg /admin /manager /phpmyadmin /wp-admin /wp-login
    acl is_sensitive_files path_end .env .git .htaccess .htpasswd .bak .sql .conf

    # Block admin and sensitive paths
    http-request deny if is_admin
    http-request deny if is_sensitive_files

    # --- Security Headers ---
    http-response set-header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    http-response set-header X-Frame-Options "DENY"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'"
    http-response set-header Referrer-Policy "strict-origin-when-cross-origin"
    http-response set-header Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
    http-response set-header X-XSS-Protection "1; mode=block"

    # Remove server information disclosure headers
    http-response del-header Server
    http-response del-header X-Powered-By
    http-response del-header X-AspNet-Version

    # --- Backend selection ---
    use_backend bk_api if is_api
    use_backend bk_static if is_static
    default_backend bk_webapp

# =============================================================================
# Frontend: HTTP redirect to HTTPS
# =============================================================================
frontend ft_http
    bind *:80
    mode http

    # Redirect all HTTP traffic to HTTPS
    http-request redirect scheme https code 301

# =============================================================================
# Backend: Web Application
# =============================================================================
backend bk_webapp
    mode http
    balance roundrobin

    # Cookie-based persistence
    cookie SRVID insert indirect nocache httponly secure

    # Connection limits per server
    default-server maxconn 250 inter 3s fall 3 rise 2

    # Health check
    option httpchk GET /health HTTP/1.1
    http-check expect status 200

    # Backend servers with SSL verification
    server webapp1 10.0.1.10:8443 ssl verify required ca-file /etc/ssl/certs/internal-ca.pem check cookie srv1
    server webapp2 10.0.1.11:8443 ssl verify required ca-file /etc/ssl/certs/internal-ca.pem check cookie srv2
    server webapp3 10.0.1.12:8443 ssl verify required ca-file /etc/ssl/certs/internal-ca.pem check cookie srv3

# =============================================================================
# Backend: API
# =============================================================================
backend bk_api
    mode http
    balance leastconn

    # Connection limits
    default-server maxconn 150 inter 5s fall 3 rise 2

    # Health check
    option httpchk GET /api/health HTTP/1.1
    http-check expect status 200

    # Rate limit API differently (stricter)
    stick-table type ip size 100k expire 1m store http_req_rate(1s)

    server api1 10.0.2.10:8443 ssl verify required ca-file /etc/ssl/certs/internal-ca.pem check
    server api2 10.0.2.11:8443 ssl verify required ca-file /etc/ssl/certs/internal-ca.pem check

# =============================================================================
# Backend: Static Content
# =============================================================================
backend bk_static
    mode http
    balance roundrobin

    # Connection limits
    default-server maxconn 500 inter 10s fall 3 rise 2

    # Health check
    option httpchk GET /static/health.txt HTTP/1.1
    http-check expect status 200

    # Cache-friendly headers for static content
    http-response set-header Cache-Control "public, max-age=86400"

    server static1 10.0.3.10:8443 ssl verify required ca-file /etc/ssl/certs/internal-ca.pem check
    server static2 10.0.3.11:8443 ssl verify required ca-file /etc/ssl/certs/internal-ca.pem check
