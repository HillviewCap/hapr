# =============================================================================
# Mixed HAProxy Configuration
# A realistic production config with some hardening but notable gaps.
# Represents a typical "got it working" config that hasn't been fully audited.
# =============================================================================

global
    # Good: chroot enabled
    chroot /var/lib/haproxy

    # Good: drops privileges
    user haproxy
    group haproxy

    # Good: logging configured
    log /dev/log local0 info
    log /dev/log local1 notice

    daemon

    maxconn 2048

    # Mixed: SSL defaults exist but allow TLS 1.0
    ssl-default-bind-options no-sslv3
    ssl-default-bind-ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:AES256-SHA

    # Good: DH param set, but could be higher (4096)
    tune.ssl.default-dh-param 2048

    # Mixed: stats socket exists but permissions are too open
    stats socket /var/run/haproxy/admin.sock mode 0660 level admin

# =============================================================================
# Defaults
# =============================================================================
defaults
    mode http
    log global

    # Good: basic logging
    option httplog
    option dontlognull

    # Good: forwardfor
    option forwardfor

    # Mixed: has basic timeouts but missing http-request timeout
    timeout connect 10s
    timeout client 60s
    timeout server 60s
    timeout queue 30s

    # Missing: timeout http-request (allows slowloris)
    # Missing: timeout http-keep-alive
    # Missing: timeout check
    # Missing: timeout client-fin / server-fin

    retries 3
    option redispatch

    # Some error files but not comprehensive
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http

# =============================================================================
# Frontend: HTTPS
# =============================================================================
frontend ft_https
    bind *:443 ssl crt /etc/ssl/private/company.pem
    mode http

    # Good: HSTS header present
    http-response set-header Strict-Transport-Security "max-age=31536000"

    # Missing: X-Frame-Options
    # Missing: Content-Security-Policy
    # Missing: X-Content-Type-Options
    # Missing: Referrer-Policy
    # Missing: Permissions-Policy

    # Good: removes Server header
    http-response del-header Server

    # Missing: does not remove X-Powered-By

    # Basic ACLs but incomplete
    acl is_api path_beg /api/
    acl is_static path_beg /static/ /assets/
    acl is_admin path_beg /admin

    # Good: blocks admin path
    http-request deny if is_admin

    # Missing: no blocking of .env, .git, .htaccess, .sql, etc.
    # Missing: no rate limiting / stick-table
    # Missing: no maxconn on frontend

    use_backend bk_api if is_api
    use_backend bk_static if is_static
    default_backend bk_webapp

# =============================================================================
# Frontend: HTTP -> HTTPS redirect
# =============================================================================
frontend ft_http
    bind *:80
    mode http

    # Good: redirects to HTTPS
    http-request redirect scheme https code 301

# =============================================================================
# Backend: Web Application
# =============================================================================
backend bk_webapp
    mode http
    balance roundrobin

    # Good: health checks enabled
    option httpchk GET /health HTTP/1.1
    http-check expect status 200

    # Missing: no connection limits (maxconn per server)
    # Missing: no cookie persistence security flags

    cookie JSESSIONID prefix

    server webapp1 10.0.1.20:8080 check cookie srv1
    server webapp2 10.0.1.21:8080 check cookie srv2

# =============================================================================
# Backend: API
# =============================================================================
backend bk_api
    mode http
    balance leastconn

    # Good: health checks
    option httpchk GET /api/health HTTP/1.1
    http-check expect status 200

    # Missing: no connection limits
    # Missing: no SSL to backend servers

    server api1 10.0.2.20:8080 check
    server api2 10.0.2.21:8080 check

# =============================================================================
# Backend: Static Content
# =============================================================================
backend bk_static
    mode http
    balance roundrobin

    # Missing: no health checks at all
    # Missing: no SSL to backend
    # Missing: no connection limits

    server static1 10.0.3.20:80
    server static2 10.0.3.21:80

# =============================================================================
# Listen: Stats page
# =============================================================================
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /haproxy-stats
    stats refresh 10s

    # Mixed: has auth but basic auth is weak, and no ACL restriction by IP
    stats auth admin:Ch4ng3M3N0w!
    stats hide-version

    # Missing: no ACL to restrict access by source IP
    # Missing: stats page bound to all interfaces, should be internal only
    # Missing: no TLS on stats page
